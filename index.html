<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AEWork Project Board">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <title>Apt Engineering Work Platform</title>
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f9fc;
            color: #333;
            min-height: 100vh;
        }
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: #1a3b5d;
            color: #fff;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo {
            height: 40px;
            margin-right: 15px;
        }
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        .module-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .module-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 25px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
        .module-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #1a3b5d;
        }
        .module-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #1a3b5d;
        }
        .module-description {
            color: #666;
            line-height: 1.5;
        }
        .module-content {
            display: none;
        }
        .module-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .back-button {
            background: #1a3b5d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .back-button:hover {
            background: #152e4a;
        }
        .module-loading {
            padding: 20px;
            text-align: center;
        }
        .module-error {
            padding: 20px;
            text-align: center;
            color: #e74c3c;
        }
        .error-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .logo-upload-container {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            border: 1px dashed #ccc;
        }
        .logo-upload-instructions {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .logo-upload-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .logo-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        .logo-primary {
            background: #0066cc;
            color: white;
        }
        .logo-secondary {
            background: #e0e0e0;
            color: #333;
        }
        /* Styles for the iframe container */
        .iframe-container {
            position: relative;
            width: 100%;
            height: 700px; /* Adjust height as needed */
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .module-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* --- Add Import/Export Styles --- */
        .header-actions {
            margin-left: auto;
            position: relative;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .menu-button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .menu-button:hover {
            background: #0055aa;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 100;
            display: none;
            min-width: 180px;
        }
        .dropdown-menu.show {
            display: block;
        }
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
            color: #333;
        }
        .dropdown-item:hover {
            background-color: #f0f0f0;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
        }
        .notification.success {
            background-color: #28a745;
        }
        .notification.error {
            background-color: #dc3545;
        }
        /* --- End Import/Export Styles --- */
        
        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .login-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            padding: 30px;
        }
        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .login-header h2 {
            color: #1a3b5d;
            margin-bottom: 10px;
        }
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-group label {
            font-weight: 600;
            color: #555;
        }
        .form-group input {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .form-group input:focus {
            outline: none;
            border-color: #1a3b5d;
            box-shadow: 0 0 0 2px rgba(26, 59, 93, 0.2);
        }
        .login-btn {
            background: #1a3b5d;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }
        .login-btn:hover {
            background: #152e4a;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-weight: 500;
        }
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #0066cc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .logout-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .register-link {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        .register-link a {
            color: #1a3b5d;
            text-decoration: none;
            font-weight: 600;
        }
        .register-link a:hover {
            text-decoration: underline;
        }
        .password-toggle {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }
        .password-input-container {
            position: relative;
        }
        .password-input-container input {
            width: 100%;
            padding-right: 40px;
        }
        .admin-override {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #1a3b5d;
        }
        .admin-override-toggle {
            color: #1a3b5d;
            text-decoration: underline;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .admin-override-fields {
            margin-top: 10px;
            display: none;
        }
        .admin-override-fields.show {
            display: block;
        }
        .change-password-required {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2001;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-container">
            <div class="login-header">
                <h2>Apt Engineering Login</h2>
                <p>Sign in to access the platform</p>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="password-input-container">
                        <input type="password" id="password" placeholder="Enter your password">
                        <button type="button" class="password-toggle" onclick="togglePassword('password')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="admin-override">
                    <div class="admin-override-toggle" onclick="toggleAdminOverride()">
                        <i class="fas fa-key"></i> Admin Override
                    </div>
                    <div class="admin-override-fields" id="adminOverrideFields">
                        <div class="form-group">
                            <label for="adminPassword">Admin Password</label>
                            <div class="password-input-container">
                                <input type="password" id="adminPassword" placeholder="Enter admin override password">
                                <button type="button" class="password-toggle" onclick="togglePassword('adminPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="login-btn" onclick="login()">Sign In</button>
                
                <div class="register-link">
                    <p>Don't have an account? <a href="#" onclick="showRegisterForm()">Register here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="login-modal" style="display: none;">
        <div class="login-container">
            <div class="login-header">
                <h2>Create Account</h2>
                <p>Register for a new account</p>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <div class="password-input-container">
                        <input type="password" id="regPassword" placeholder="Create a password">
                        <button type="button" class="password-toggle" onclick="togglePassword('regPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="regFullName">Full Name</label>
                    <input type="text" id="regFullName" placeholder="Your full name">
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" placeholder="Your email address">
                </div>
                <div class="form-group">
                    <label for="regRole">Role</label>
                    <select id="regRole" style="padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px;">
                        <option value="user">Standard User</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <button class="login-btn" onclick="register()">Create Account</button>
                
                <div class="register-link">
                    <p>Already have an account? <a href="#" onclick="showLoginForm()">Sign in here</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="login-modal" style="display: none;">
        <div class="login-container">
            <div class="login-header">
                <h2>Change Password</h2>
                <p>You must change your password to continue</p>
            </div>
            <div class="login-form">
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <div class="password-input-container">
                        <input type="password" id="currentPassword" placeholder="Enter current password">
                        <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password</label>
                    <div class="password-input-container">
                        <input type="password" id="newPassword" placeholder="Enter new password">
                        <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password</label>
                    <div class="password-input-container">
                        <input type="password" id="confirmPassword" placeholder="Confirm new password">
                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button class="login-btn" onclick="changePassword()">Update Password</button>
            </div>
        </div>
    </div>

    <div class="app-container" id="mainApp" style="display: none;">
        <header>
            <img src="logo/logo.jpg" onerror="this.onerror=null; this.src='https://via.placeholder.com/120x40?text=LOGO';" alt="Apt Engineering Logo" class="logo">
            <h1>Apt Engineering Work Platform</h1>
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="userName">User</div>
                    <div id="userRole" style="font-size: 0.8rem; opacity: 0.8;">Role</div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
                <button class="logout-btn" onclick="showChangePasswordModal()" style="margin-left: 10px;">
                    <i class="fas fa-key"></i> Change Password
                </button>
            </div>
            <!-- --- Import/Export UI --- -->
            <div class="header-actions">
                <button class="menu-button" id="menuButton">
                    <i class="fas fa-ellipsis-v"></i> Actions
                </button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <button class="dropdown-item" id="exportBtn">
                        <i class="fas fa-file-export"></i> Export All Data
                    </button>
                    <button class="dropdown-item" id="importBtn">
                        <i class="fas fa-file-import"></i> Import All Data
                    </button>
                    <button class="dropdown-item" id="manageUsersBtn" style="display: none;">
                        <i class="fas fa-users-cog"></i> Manage Users
                    </button>
                </div>
            </div>
            <!-- --- End Import/Export UI --- -->
        </header>

        <!-- --- Notifications --- -->
        <div id="notification" class="notification"></div>
        <!-- --- End Notifications --- -->

        <div id="moduleSelector" class="module-selector">
            <div class="module-card" onclick="loadModule('project-board')">
                <div class="module-icon">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <h2 class="module-title">Project Board</h2>
                <p class="module-description">Manage projects, tasks, and team performance with our comprehensive project management system</p>
            </div>
            <div class="module-card" onclick="loadModule('kpi-monitor')">
                <div class="module-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h2 class="module-title">KPI Monitor</h2>
                <p class="module-description">Track and analyze key performance indicators across all departments and roles</p>
            </div>
            <!-- New Payroll Manager Module -->
            <div class="module-card" onclick="loadModule('payroll-manager')">
                <div class="module-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <h2 class="module-title">Payroll Manager</h2>
                <p class="module-description">Manage employee payroll, deductions, and generate payslips for your workforce</p>
            </div>
            <!-- New Work Manager Module -->
            <div class="module-card" onclick="loadModule('work-manager')">
                <div class="module-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <h2 class="module-title">Work Manager</h2>
                <p class="module-description">Integrated project and material database system for engineering works management</p>
            </div>
        </div>
        
        <!-- Module content areas will be populated by JavaScript -->
        <div id="project-boardModule" class="module-content"></div>
        <div id="kpi-monitorModule" class="module-content"></div>
        <div id="payroll-managerModule" class="module-content"></div>
        <div id="work-managerModule" class="module-content"></div>

        <div class="logo-upload-container">
            <div class="logo-upload-instructions">
                <i class="fas fa-info-circle" style="font-size: 2rem; color: #0066cc;"></i>
                <div>
                    <h3>Customize Your Company Logo</h3>
                    <p>Replace the placeholder logo with your company logo for a personalized experience</p>
                </div>
            </div>
            <div class="logo-upload-actions">
                <button class="logo-btn logo-primary" onclick="showLogoInstructions()">
                    <i class="fas fa-image"></i> How to Add Your Logo
                </button>
                <button class="logo-btn logo-secondary" onclick="window.open('logo', '_blank')">
                    <i class="fas fa-folder-open"></i> Open Logo Folder
                </button>
            </div>
        </div>
    </div>
    <script>
        // User management system
        const USER_STORAGE_KEY = "apt_engineering_users";
        const CURRENT_USER_KEY = "apt_engineering_current_user";
        const MASTER_ADMIN_PASSWORD = "AptMaster2024!"; // Master password only available to you
        
        // Default users (for demo purposes)
        const DEFAULT_USERS = [
            { 
                username: "admin", 
                password: "admin123", 
                fullName: "System Administrator", 
                email: "admin@aptengineering.com", 
                role: "admin",
                avatar: "A",
                firstLogin: true,
                passwordChanged: false
            },
            { 
                username: "manager", 
                password: "manager123", 
                fullName: "Project Manager", 
                email: "manager@aptengineering.com", 
                role: "manager",
                avatar: "M",
                firstLogin: true,
                passwordChanged: false
            },
            { 
                username: "user", 
                password: "user123", 
                fullName: "Standard User", 
                email: "user@aptengineering.com", 
                role: "user",
                avatar: "U",
                firstLogin: true,
                passwordChanged: false
            }
        ];
        
        let currentUser = null;
        
        // Initialize user system
        function initUserSystem() {
            // Check if users exist in localStorage, if not create default ones
            let storedUsers = [];
            try {
                const storedData = localStorage.getItem(USER_STORAGE_KEY);
                if (storedData) {
                    storedUsers = JSON.parse(storedData);
                    if (!Array.isArray(storedUsers)) {
                        throw new Error("Stored users data is not an array");
                    }
                }
            } catch (e) {
                console.error("Error parsing stored users:", e);
                storedUsers = [];
            }
            
            if (storedUsers.length === 0) {
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(DEFAULT_USERS));
            }
            
            const storedUser = localStorage.getItem(CURRENT_USER_KEY);
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    if (currentUser.firstLogin) {
                        showChangePasswordModal();
                    } else {
                        showApp();
                    }
                } catch (e) {
                    console.error("Error parsing current user:", e);
                    showLogin();
                }
            } else {
                showLogin();
            }
        }
        
        // Show login form
        function showLogin() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('registerModal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminOverrideFields').classList.remove('show');
        }
        
        // Show registration form
        function showRegisterForm() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('registerModal').style.display = 'flex';
            document.getElementById('changePasswordModal').style.display = 'none';
        }
        
        // Show login form from registration
        function showLoginForm() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('registerModal').style.display = 'none';
            document.getElementById('changePasswordModal').style.display = 'none';
        }
        
        // Show change password modal
        function showChangePasswordModal() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('registerModal').style.display = 'none';
            document.getElementById('changePasswordModal').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        // Show the main application
        function showApp() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('registerModal').style.display = 'none';
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.fullName;
            document.getElementById('userRole').textContent = capitalizeFirstLetter(currentUser.role);
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            if (currentUser.role === 'admin') {
                document.getElementById('manageUsersBtn').style.display = 'block';
            } else {
                document.getElementById('manageUsersBtn').style.display = 'none';
            }
        }
        
        // Toggle password visibility
        function togglePassword(fieldId) {
            const passwordField = document.getElementById(fieldId);
            const toggleButton = passwordField.nextElementSibling;
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                passwordField.type = 'password';
                toggleButton.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }
        
        // Toggle admin override fields
        function toggleAdminOverride() {
            document.getElementById('adminOverrideFields').classList.toggle('show');
        }
        
        // Login function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const adminPassword = document.getElementById('adminPassword').value;
            const useAdminOverride = document.getElementById('adminOverrideFields').classList.contains('show') && adminPassword;
            
            if (!username || !password) {
                showNotification('Please enter both username and password', 'error');
                return;
            }
            
            let users = [];
            try {
                users = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || '[]');
            } catch (e) {
                showNotification('Error accessing user database', 'error');
                return;
            }
            
            if (useAdminOverride) {
                if (adminPassword === MASTER_ADMIN_PASSWORD) {
                    const user = users.find(u => u.username.toLowerCase() === username.toLowerCase());
                    if (user) {
                        currentUser = user;
                        localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(user));
                        if (user.firstLogin) {
                            showChangePasswordModal();
                        } else {
                            showApp();
                        }
                        showNotification(`Admin override used. Welcome, ${user.fullName}!`, 'success');
                    } else {
                        showNotification('User not found with admin override', 'error');
                    }
                } else {
                    showNotification('Invalid admin password', 'error');
                }
                return;
            }
            
            const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(user));
                if (user.firstLogin) {
                    showChangePasswordModal();
                } else {
                    showApp();
                }
                showNotification(`Welcome back, ${user.fullName}!`, 'success');
            } else {
                showNotification('Invalid username or password', 'error');
            }
        }
        
        // Register function
        function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const fullName = document.getElementById('regFullName').value;
            const email = document.getElementById('regEmail').value;
            const role = document.getElementById('regRole').value;
            
            if (!username || !password || !fullName || !email) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            let users = [];
            try {
                users = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || '[]');
            } catch (e) {
                showNotification('Error accessing user database', 'error');
                return;
            }
            
            if (users.some(u => u.username.toLowerCase() === username.toLowerCase())) {
                showNotification('Username already exists', 'error');
                return;
            }
            
            if (users.some(u => u.email.toLowerCase() === email.toLowerCase())) {
                showNotification('Email already registered', 'error');
                return;
            }
            
            const newUser = {
                username, password, fullName, email, role,
                avatar: fullName.charAt(0).toUpperCase(),
                firstLogin: true,
                passwordChanged: false
            };
            
            users.push(newUser);
            
            try {
                localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
                showNotification('Account created successfully! You can now login.', 'success');
                showLoginForm();
            } catch (e) {
                showNotification('Error creating account. Please try again.', 'error');
            }
        }
        
        // Change password function
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Please fill in all password fields', 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }
            if (newPassword.length < 6) {
                showNotification('New password must be at least 6 characters', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem(USER_STORAGE_KEY) || '[]');
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            
            if (userIndex === -1) {
                showNotification('User not found', 'error');
                return;
            }
            if (!currentUser.firstLogin && users[userIndex].password !== currentPassword) {
                showNotification('Current password is incorrect', 'error');
                return;
            }
            
            users[userIndex].password = newPassword;
            users[userIndex].firstLogin = false;
            users[userIndex].passwordChanged = true;
            
            currentUser = users[userIndex];
            
            localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(users));
            localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser));
            
            showNotification('Password updated successfully!', 'success');
            showApp();
        }
        
        // Logout function
        function logout() {
            currentUser = null;
            localStorage.removeItem(CURRENT_USER_KEY);
            showLogin();
            showNotification('You have been logged out', 'success');
        }
        
        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // --- Service Worker Registration ---
        if (window.location.protocol === 'https:' || window.location.hostname === 'localhost') {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(registration => console.log('ServiceWorker registered: ', registration))
                        .catch(error => console.log('ServiceWorker registration failed: ', error));
                });
            }
        }
        // --- End Service Worker Registration ---

        // --- Import/Export Logic ---
        let sw = null;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                sw = reg;
                navigator.serviceWorker.addEventListener('message', event => {
                    if (event.data.type === 'EXPORT_DATA_RESPONSE') {
                        if (event.data.success) {
                            downloadJSON(event.data.data, `ae-work-export-${new Date().toISOString().slice(0, 10)}.json`);
                            showNotification('All data exported successfully!', 'success');
                        } else {
                            showNotification('Export failed: ' + (event.data.error || 'Unknown error'), 'error');
                        }
                    }
                    if (event.data.type === 'IMPORT_DATA_RESPONSE') {
                        if (event.data.success) {
                            showNotification('All data imported successfully! Reloading modules...', 'success');
                            document.querySelectorAll('.module-content.active').forEach(module => {
                                const iframe = module.querySelector('iframe');
                                if (iframe) iframe.contentWindow.postMessage({ type: 'RELOAD_DATA' }, '*');
                            });
                        } else {
                            showNotification('Import failed: ' + (event.data.error || 'Unknown error'), 'error');
                        }
                    }
                });
            });
        }

        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
        }

        function exportAllData() {
            if (sw && sw.active) {
                sw.active.postMessage({ type: 'EXPORT_DATA_REQUEST' });
            } else {
                showNotification('Service worker not ready. Please try again.', 'error');
            }
        }

        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (sw && sw.active) {
                            sw.active.postMessage({ type: 'IMPORT_DATA_REQUEST', data });
                        } else {
                            showNotification('Service worker not ready. Please try again.', 'error');
                        }
                    } catch (error) {
                        showNotification('Invalid JSON file. Please select a valid export file.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        // --- End Import/Export Logic ---

        // --- Notification System ---
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        // --- End Notification System ---

        // --- Module Loading Logic ---
        function loadModule(moduleName) {
            // Hide the main module selector
            document.getElementById('moduleSelector').style.display = 'none';
            const moduleElement = document.getElementById(`${moduleName}Module`);
            
            // Set the HTML for the module, including the back button and the iframe container
            moduleElement.innerHTML = `
                <button class="back-button" onclick="showModuleSelector()">
                    <i class="fas fa-arrow-left"></i> Back to Main Menu
                </button>
                <div class="iframe-container">
                    <iframe id="${moduleName}Iframe" class="module-iframe" title="${moduleName.replace(/-/g, ' ')}"></iframe>
                </div>
            `;
            // Show the module content area
            moduleElement.classList.add('active');
            // Find the new iframe we just created
            const iframe = document.getElementById(`${moduleName}Iframe`);

            // Set the source of the iframe based on the module clicked
            switch(moduleName) {
                case 'project-board':
                    iframe.src = 'project-board.html';
                    break;
                case 'kpi-monitor':
                    iframe.src = 'kpi-monitor.html';
                    break;
                case 'payroll-manager':
                    iframe.src = 'apt-payroll-manager.html';
                    break;
                case 'work-manager':
                    iframe.src = 'apt-work-manager.html';
                    break;
                default:
                    // If the module file doesn't exist, show an error inside the module area
                    moduleElement.innerHTML = `
                        <button class="back-button" onclick="showModuleSelector()">
                            <i class="fas fa-arrow-left"></i> Back to Main Menu
                        </button>
                        <div class="module-error">
                            <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <p>Module not found or not implemented yet.</p>
                        </div>
                    `;
            }
        }

        function showModuleSelector() {
            // Hide all modules
            document.querySelectorAll('.module-content').forEach(module => {
                module.classList.remove('active');
            });
            // Show module selector
            document.getElementById('moduleSelector').style.display = 'grid';
        }

        function showLogoInstructions() {
            alert("To add your company logo:\n\n1. Create a folder named 'logo' in the same directory as this app\n2. Place your logo file (jpg, png) inside this folder\n3. Name the file 'logo.jpg' or 'logo.png'\n4. Refresh the app to see your logo");
        }
        // --- End Module Loading Logic ---

        // --- Initialize App ---
        document.addEventListener('DOMContentLoaded', function() {
            initUserSystem();
            const menuButton = document.getElementById('menuButton');
            const dropdownMenu = document.getElementById('dropdownMenu');
            
            menuButton.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownMenu.classList.toggle('show');
            });
            document.addEventListener('click', () => dropdownMenu.classList.remove('show'));
            dropdownMenu.addEventListener('click', e => e.stopPropagation());
            
            document.getElementById('exportBtn').addEventListener('click', exportAllData);
            document.getElementById('importBtn').addEventListener('click', importAllData);
            document.getElementById('manageUsersBtn').addEventListener('click', () => alert('User management feature will be implemented here'));
        });
        // --- End Initialize App ---
    </script>
</body>
</html>