<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apt Engineering Works Payroll System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e7f0 100%);
      padding: 12px;
      min-height: 100vh;
      font-size: 14px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header Styles - Mobile Optimized */
    header {
      background: linear-gradient(to right, #1a3a6c, #2c5282);
      color: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .header-content {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }
    .logo-container {
      background: white;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .logo-placeholder {
      width: 40px;
      height: 40px;
      background: linear-gradient(45deg, #2c5282, #1a3a6c);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }
    .logo-placeholder span {
      transform: rotate(-15deg);
    }
    .header-text {
      flex: 1;
      min-width: 0;
    }
    .header-text h1 {
      font-size: 18px;
      margin-bottom: 3px;
    }
    .header-text p {
      opacity: 0.9;
      font-size: 13px;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      width: 100%;
    }
    .upload-btn {
      background: white;
      color: #2c5282;
      border: none;
      padding: 8px 10px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      font-size: 13px;
      flex: 1;
      min-width: 140px;
      justify-content: center;
    }
    .upload-btn:hover {
      background: #f0f4f8;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    #logoInput {
      display: none;
    }

    /* Mobile Navigation */
    .mobile-menu-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: block;
      padding: 5px;
    }

    /* Content Layout - Stacked on Mobile */
    .content {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    /* Panel Styles - Collapsible on Mobile */
    .panel {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 15px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .panel-header h2 {
      color: #2c5282;
      padding-bottom: 8px;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-content {
      margin-top: 15px;
    }
    .collapsed .panel-content {
      display: none;
    }
    .toggle-icon {
      transition: transform 0.3s;
    }
    .collapsed .toggle-icon {
      transform: rotate(180deg);
    }

    /* Form Styles */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .toggle-container label {
      font-weight: 500;
      color: #4a5568;
      font-size: 14px;
    }
    .deductions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #4a5568;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
    }

    /* Button Styles - Larger for Mobile */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      font-size: 13px;
      flex: 1;
      min-width: 140px;
      justify-content: center;
    }
    .btn-primary {
      background: linear-gradient(to right, #3182ce, #2b6cb0);
      color: white;
    }
    .btn-success {
      background: linear-gradient(to right, #38a169, #2f855a);
      color: white;
    }
    .btn-warning {
      background: linear-gradient(to right, #ed8936, #dd6b20);
      color: white;
    }
    .btn-danger {
      background: linear-gradient(to right, #e53e3e, #c53030);
      color: white;
    }
    .btn-info {
      background: linear-gradient(to right, #00b5d8, #0987a0);
      color: white;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Table Styles - Scrollable on Mobile */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      margin-top: 10px;
      background: white;
      -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th {
      background: linear-gradient(to bottom, #2c5282, #1a3a6c);
      color: white;
      padding: 10px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
    }
    td {
      padding: 8px 6px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
      font-size: 12px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:nth-child(even) {
      background-color: #f8fafc;
    }

    /* Input Fields */
    .input-field {
      width: 100%;
      padding: 7px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      background: #fff9c4;
      font-size: 12px;
      min-width: 60px;
    }
    .calculated-value {
      width: 100%;
      padding: 7px;
      border: none;
      border-radius: 4px;
      background: #e0e0e0;
      font-weight: 500;
      font-size: 12px;
      text-align: center;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Summary Section - Stacked on Mobile */
    .summary {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      font-weight: 600;
      color: #2d3748;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-around;
    }
    .summary-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px;
      min-width: 120px;
      flex: 1;
    }
    .summary-value {
      font-size: 14px;
      color: #2c5282;
      margin-top: 5px;
      white-space: nowrap;
    }

    /* Payslip Styles */
    .payslip-container {
      display: none;
    }
    .payslip-page {
      page-break-after: always;
      padding: 10px;
    }
    .payslip {
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 15px auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 100%;
      font-size: 12px;
    }
    .payslip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
      flex-wrap: wrap;
      gap: 10px;
    }
    .payslip-logo img {
      max-width: 80px;
      height: auto;
    }
    .payslip-company-details h2 {
      font-size: 15px;
      margin-bottom: 4px;
    }
    .payslip-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 5px;
    }
    .payslip-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 11px;
    }
    .payslip-table th,
    .payslip-table td {
      border: 1px solid #aaa;
      padding: 4px 6px;
      font-size: 10px;
    }
    .payslip-table th {
      background: #f0f0f0;
      font-weight: bold;
    }
    .confidential-footer {
      margin-top: 15px;
      text-align: center;
      font-size: 8px;
      color: #666;
      font-style: italic;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }
    .print-button {
      text-align: center;
      margin-top: 10px;
    }
    .signature-section {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    .signature-box {
      width: 48%;
      text-align: center;
    }
    .signature-line {
      height: 1px;
      background: #000;
      margin: 5px 0 10px;
    }
    .payslip-dual {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    .payslip-copy {
      width: 48%;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      position: relative;
    }
    .copy-label {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #f0f0f0;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: bold;
    }
    
    /* NEW: Print-specific Styles */
    @media print {
      body {
        background: white;
        color: black;
        font-size: 12px;
        margin: 0;
        padding: 0;
      }
      body > *:not(.payslip-container) {
        display: none !important;
      }
      .payslip-container {
        display: block !important;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .payslip-page {
        width: 100%;
        page-break-after: always;
        margin: 0;
        padding: 0;
      }
      .payslip {
        width: 100%;
        margin: 0;
        box-shadow: none;
        border: none;
        padding: 10px;
      }
      .payslip-table th,
      .payslip-table td {
        border: 1px solid #000;
      }
      .print-button {
        display: none;
      }
      .confidential-footer {
        font-size: 8px;
      }
      .signature-section {
        display: flex;
      }
      .signature-box {
        width: 48%;
      }
      .payslip-dual {
        display: flex;
        gap: 15px;
      }
      .payslip-copy {
        width: 48%;
        border: 1px solid #000;
      }
      @page {
        size: A4 landscape;
        margin: 1cm;
      }
    }

    /* Toggle for Calculated Fields */
    #payrollTable.hide-calculated .calculated-cell {
      display: none;
    }
    #payrollTable.hide-calculated .input-field {
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      width: auto;
    }
    #payrollTable.hide-calculated td:not(.calculated-cell) {
      width: auto;
    }

    /* History Panel Styles */
    .history-panel {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .history-header h2 {
      color: #2c5282;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    .history-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #2c5282;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .history-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .history-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    .history-card-title {
      font-weight: 600;
      color: #2c5282;
      font-size: 15px;
    }
    .history-card-date {
      font-size: 12px;
      color: #718096;
    }
    .history-card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .history-card-item {
      margin-bottom: 5px;
    }
    .history-card-label {
      font-size: 11px;
      color: #718096;
      font-weight: 500;
    }
    .history-card-value {
      font-size: 13px;
      font-weight: 600;
      color: #2d3748;
    }
    .history-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .history-btn {
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .history-btn i {
      font-size: 10px;
    }

    /* Payment Date Selector */
    .payment-date-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    .payment-date-selector label {
      font-weight: 500;
      color: #4a5568;
      white-space: nowrap;
    }
    .payment-date-selector input {
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 13px;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 15px;
      overflow-x: auto; /* Enable horizontal scrolling for tabs */
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
    }
    .tab-btn {
      padding: 10px 15px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab-btn.active {
      color: #2c5282;
      border-bottom-color: #2c5282;
    }
    .tab-btn:hover:not(.active) {
      color: #3182ce;
      border-bottom-color: #bee3f8;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Mobile-specific Styles */
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      .header-text h1 {
        font-size: 16px;
      }
      .header-text p {
        font-size: 12px;
      }
      .logo-placeholder {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }
      .panel-header h2 {
        font-size: 16px;
      }
      .summary {
        flex-direction: column;
        gap: 8px;
      }
      .summary-item {
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
        padding: 8px;
        background: #f8fafc;
        border-radius: 6px;
      }
      .action-buttons {
        flex-direction: column;
      }
      .btn {
        width: 100%;
      }
      .controls {
        gap: 5px;
      }
      .upload-btn {
        min-width: 0;
      }
      .history-grid {
        grid-template-columns: 1fr;
      }
      .payment-date-selector {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    
    /* Tablet Styles */
    @media (min-width: 768px) {
      .content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
      }
      .panel {
        margin-bottom: 0;
      }
      header {
        flex-direction: row;
        justify-content: space-between;
      }
      .controls {
        width: auto;
        margin-top: 0;
      }
    }
    
    /* Desktop Styles */
    @media (min-width: 992px) {
      .content {
        grid-template-columns: 1fr 1.8fr;
      }
      .mobile-menu-btn {
        display: none;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-content">
      <button class="mobile-menu-btn">
        <i class="fas fa-bars"></i>
      </button>
      <div class="logo-container">
        <div class="logo-placeholder" id="companyLogo">
          <span>AE</span>
        </div>
      </div>
      <div class="header-text">
        <h1>Apt Engineering Works Ltd</h1>
        <p>Advanced Payroll Management System</p>
      </div>
    </div>
    <div class="controls">
      <button class="upload-btn" onclick="document.getElementById('logoInput').click()">
        <i class="fas fa-upload"></i> Upload Logo
      </button>
      <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)">
    </div>
  </header>
  
  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button class="tab-btn active" onclick="switchTab('current')">
      <i class="fas fa-file-invoice-dollar"></i> Current Payroll
    </button>
    <button class="tab-btn" onclick="switchTab('history')">
      <i class="fas fa-history"></i> Payment History
    </button>
    <button class="tab-btn" onclick="switchTab('settings')">
      <i class="fas fa-cog"></i> Settings
    </button>
  </div>
  
  <!-- Current Payroll Tab -->
  <div id="currentTab" class="tab-content active">
    <div class="content">
      <div class="panel">
        <div class="panel-header" onclick="togglePanel(this)">
          <h2><i class="fas fa-cog"></i> Deduction Settings</h2>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="panel-content">
          <div class="payment-date-selector">
            <label for="paymentDate"><i class="far fa-calendar-alt"></i> Payment Date:</label>
            <input type="date" id="paymentDate" onchange="updatePaymentDate()">
          </div>
          <div class="toggle-container">
            <input type="checkbox" id="toggleDeductions" checked>
            <label for="toggleDeductions">Show Deduction Rates</label>
          </div>
          <div class="toggle-container">
            <input type="checkbox" id="toggleCalculated" checked>
            <label for="toggleCalculated">Show Calculated Fields</label>
          </div>
          <div class="deductions-grid" id="deductionsPanel">
            <!-- Deduction Fields -->
            <div class="form-group">
              <label><i class="fas fa-percent"></i> PAYE - Permanent (%)</label>
              <input type="number" id="payePermanent" value="12" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-percent"></i> PAYE - Contract (%)</label>
              <input type="number" id="payeContract" value="5" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-money-bill-wave"></i> Staff Pension - Permanent (%)</label>
              <input type="number" id="staffPensionPermanent" value="7.5" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-building"></i> Company Pension (%)</label>
              <input type="number" id="companyPension" value="15" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-heartbeat"></i> Medicals Insurance (%)</label>
              <input type="number" id="medicals" value="1" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-hard-hat"></i> Workmen Insurance (%)</label>
              <input type="number" id="workmen" value="1" step="0.1">
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn btn-warning" onclick="addEmployee()">
              <i class="fas fa-user-plus"></i> Add Employee
            </button>
            <button class="btn btn-success" onclick="saveData()">
              <i class="fas fa-save"></i> Save Data
            </button>
            <button class="btn btn-primary" onclick="printPayslips()">
              <i class="fas fa-print"></i> Print Payslips
            </button>
          </div>
        </div>
      </div>
      
      <div class="panel">
        <div class="panel-header" onclick="togglePanel(this)">
          <h2><i class="fas fa-table"></i> Payroll Summary & Table</h2>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="panel-content">
          <div class="summary" id="summaryPanel">
            <!-- Summary data will be rendered here -->
          </div>
          <div class="table-container">
            <table id="payrollTable">
              <thead>
              <tr>
                <th>#</th>
                <th>Employee Name</th>
                <th>Staff ID</th>
                <th>Type</th>
                <th>Bank</th>
                <th>Account</th>
                <th>Base Pay</th>
                <th>Overtime</th>
                <th>Allowances</th>
                <th class="calculated-cell">Gross Pay</th>
                <th>Deductions</th>
                <th class="calculated-cell">Total Deductions</th>
                <th class="calculated-cell">Net Pay</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody>
              <!-- Employee rows will be rendered here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Payment History Tab -->
  <div id="historyTab" class="tab-content">
    <div class="history-panel">
      <div class="history-header">
        <h2><i class="fas fa-history"></i> Payment History</h2>
      </div>
      <div class="history-grid" id="historyGrid">
        <!-- History cards will be rendered here -->
      </div>
    </div>
  </div>
  
  <!-- Settings Tab -->
  <div id="settingsTab" class="tab-content">
    <div class="history-panel">
      <div class="history-header">
        <h2><i class="fas fa-cog"></i> System Settings</h2>
        <div class="action-buttons">
          <button class="btn btn-info" onclick="exportData()">
            <i class="fas fa-file-export"></i> Export Data
          </button>
          <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
          <button class="btn btn-info" onclick="document.getElementById('importFile').click()">
            <i class="fas fa-file-import"></i> Import Data
          </button>
          <button class="btn btn-danger" onclick="resetData()">
            <i class="fas fa-trash-alt"></i> Reset All Data
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Payslip Print Preview Container -->
<div class="payslip-container" id="payslipContainer">
  <!-- Payslips will be generated here for printing -->
</div>

<script>
    // Global state
    let employees = [];
    let history = [];
    const localStorageKey = 'aptPayrollData';
    let companyLogo = null;
    let paymentDate = new Date().toISOString().split('T')[0];

    // Functions to handle data and rendering
    const formatCurrency = (value) => {
        return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(value);
    };

    const saveData = () => {
        const data = {
            employees: employees,
            history: history,
            deductionRates: {
                payePermanent: parseFloat(document.getElementById('payePermanent').value),
                payeContract: parseFloat(document.getElementById('payeContract').value),
                staffPensionPermanent: parseFloat(document.getElementById('staffPensionPermanent').value),
                companyPension: parseFloat(document.getElementById('companyPension').value),
                medicals: parseFloat(document.getElementById('medicals').value),
                workmen: parseFloat(document.getElementById('workmen').value),
            },
            paymentDate: paymentDate,
            logo: companyLogo
        };
        localStorage.setItem(localStorageKey, JSON.stringify(data));
        renderSummary();
    };

    const loadData = () => {
        try {
            const data = JSON.parse(localStorage.getItem(localStorageKey));
            if (data) {
                employees = data.employees || [];
                history = data.history || [];
                document.getElementById('payePermanent').value = data.deductionRates?.payePermanent || 12;
                document.getElementById('payeContract').value = data.deductionRates?.payeContract || 5;
                document.getElementById('staffPensionPermanent').value = data.deductionRates?.staffPensionPermanent || 7.5;
                document.getElementById('companyPension').value = data.deductionRates?.companyPension || 15;
                document.getElementById('medicals').value = data.deductionRates?.medicals || 1;
                document.getElementById('workmen').value = data.deductionRates?.workmen || 1;
                paymentDate = data.paymentDate || new Date().toISOString().split('T')[0];
                companyLogo = data.logo || null;

                if (companyLogo) {
                    setLogo(companyLogo);
                }

            } else {
                resetToDefaultData();
            }
        } catch (e) {
            console.error("Error loading data from localStorage:", e);
            resetToDefaultData();
        }
    };

    const resetToDefaultData = () => {
        employees = [];
        history = [];
        document.getElementById('payePermanent').value = 12;
        document.getElementById('payeContract').value = 5;
        document.getElementById('staffPensionPermanent').value = 7.5;
        document.getElementById('companyPension').value = 15;
        document.getElementById('medicals').value = 1;
        document.getElementById('workmen').value = 1;
        paymentDate = new Date().toISOString().split('T')[0];
        companyLogo = null;
        localStorage.removeItem(localStorageKey);
        localStorage.removeItem('companyLogo');
    };

    const calculateTotals = (employee) => {
        const payeRate = employee.type === 'Permanent' ? parseFloat(document.getElementById('payePermanent').value) : parseFloat(document.getElementById('payeContract').value);
        const staffPensionRate = employee.type === 'Permanent' ? parseFloat(document.getElementById('staffPensionPermanent').value) : 0;
        const companyPensionRate = employee.type === 'Permanent' ? parseFloat(document.getElementById('companyPension').value) : 0;
        const medicalsRate = parseFloat(document.getElementById('medicals').value);
        const workmenRate = parseFloat(document.getElementById('workmen').value);

        const grossPay = parseFloat(employee.basePay) + parseFloat(employee.overtime) + parseFloat(employee.allowances);
        const payeDeduction = (grossPay * payeRate) / 100;
        const staffPensionDeduction = (grossPay * staffPensionRate) / 100;
        const medicalsDeduction = (grossPay * medicalsRate) / 100;
        const workmenDeduction = (grossPay * workmenRate) / 100;

        const totalDeductions = payeDeduction + staffPensionDeduction + medicalsDeduction + workmenDeduction + parseFloat(employee.otherDeductions);
        const netPay = grossPay - totalDeductions;

        return {
            grossPay: grossPay,
            paye: payeDeduction,
            staffPension: staffPensionDeduction,
            medicals: medicalsDeduction,
            workmen: workmenDeduction,
            totalDeductions: totalDeductions,
            netPay: netPay,
            companyPension: (grossPay * companyPensionRate) / 100, // Company contribution
            payeRate: payeRate,
            staffPensionRate: staffPensionRate,
            medicalsRate: medicalsRate,
            workmenRate: workmenRate
        };
    };

    const renderTable = () => {
        const tableBody = document.querySelector('#payrollTable tbody');
        tableBody.innerHTML = '';
        employees.forEach((employee, index) => {
            const totals = calculateTotals(employee);
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><input type="text" class="input-field" value="${employee.name}" onchange="updateEmployee(${index}, 'name', this.value)"></td>
                <td><input type="text" class="input-field" value="${employee.staffID}" onchange="updateEmployee(${index}, 'staffID', this.value)"></td>
                <td>
                    <select class="input-field" onchange="updateEmployee(${index}, 'type', this.value)">
                        <option value="Permanent" ${employee.type === 'Permanent' ? 'selected' : ''}>Permanent</option>
                        <option value="Contract" ${employee.type === 'Contract' ? 'selected' : ''}>Contract</option>
                    </select>
                </td>
                <td><input type="text" class="input-field" value="${employee.bank}" onchange="updateEmployee(${index}, 'bank', this.value)"></td>
                <td><input type="text" class="input-field" value="${employee.account}" onchange="updateEmployee(${index}, 'account', this.value)"></td>
                <td><input type="number" class="input-field" value="${employee.basePay}" step="0.01" onchange="updateEmployee(${index}, 'basePay', parseFloat(this.value))"></td>
                <td><input type="number" class="input-field" value="${employee.overtime}" step="0.01" onchange="updateEmployee(${index}, 'overtime', parseFloat(this.value))"></td>
                <td><input type="number" class="input-field" value="${employee.allowances}" step="0.01" onchange="updateEmployee(${index}, 'allowances', parseFloat(this.value))"></td>
                <td class="calculated-cell"><span class="calculated-value">${formatCurrency(totals.grossPay)}</span></td>
                <td><input type="number" class="input-field" value="${employee.otherDeductions}" step="0.01" onchange="updateEmployee(${index}, 'otherDeductions', parseFloat(this.value))"></td>
                <td class="calculated-cell"><span class="calculated-value">${formatCurrency(totals.totalDeductions)}</span></td>
                <td class="calculated-cell"><span class="calculated-value">${formatCurrency(totals.netPay)}</span></td>
                <td>
                    <button class="btn btn-danger" onclick="deleteEmployee(${index})"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        renderSummary();
    };

    const updateEmployee = (index, key, value) => {
        employees[index][key] = value;
        saveData();
        renderTable();
    };

    const addEmployee = () => {
        employees.push({
            name: 'New Employee',
            staffID: '',
            type: 'Permanent',
            bank: '',
            account: '',
            basePay: 0,
            overtime: 0,
            allowances: 0,
            otherDeductions: 0
        });
        saveData();
        renderTable();
    };

    const deleteEmployee = (index) => {
      const confirmDelete = window.confirm(`Are you sure you want to delete ${employees[index].name}?`);
      if (confirmDelete) {
        employees.splice(index, 1);
        saveData();
        renderTable();
      }
    };

    const renderSummary = () => {
        const summaryPanel = document.getElementById('summaryPanel');
        const totalGrossPay = employees.reduce((acc, emp) => acc + calculateTotals(emp).grossPay, 0);
        const totalDeductions = employees.reduce((acc, emp) => acc + calculateTotals(emp).totalDeductions, 0);
        const totalNetPay = employees.reduce((acc, emp) => acc + calculateTotals(emp).netPay, 0);

        summaryPanel.innerHTML = `
            <div class="summary-item">
                <span>Total Employees</span>
                <span class="summary-value">${employees.length}</span>
            </div>
            <div class="summary-item">
                <span>Total Gross Pay</span>
                <span class="summary-value">${formatCurrency(totalGrossPay)}</span>
            </div>
            <div class="summary-item">
                <span>Total Deductions</span>
                <span class="summary-value">${formatCurrency(totalDeductions)}</span>
            </div>
            <div class="summary-item">
                <span>Total Net Pay</span>
                <span class="summary-value">${formatCurrency(totalNetPay)}</span>
            </div>
        `;
    };

    const togglePanel = (header) => {
        header.closest('.panel').classList.toggle('collapsed');
    };

    const handleLogoUpload = (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                companyLogo = e.target.result;
                setLogo(companyLogo);
                saveData();
            };
            reader.readAsDataURL(file);
        }
    };

    const setLogo = (logoData) => {
        const logoPlaceholder = document.getElementById('companyLogo');
        logoPlaceholder.innerHTML = `<img src="${logoData}" alt="Company Logo">`;
    };
    
    // NEW: Function to generate and print payslips
    const printPayslips = () => {
        const payslipContainer = document.getElementById('payslipContainer');
        payslipContainer.innerHTML = ''; // Clear previous payslips

        if (employees.length === 0) {
            alert('No employees to generate payslips for. Please add employees first.');
            return;
        }

        const payslipsHTML = employees.map(emp => {
            const totals = calculateTotals(emp);
            
            const payslipContent = (copyType) => `
                <div class="payslip-copy">
                    <span class="copy-label">${copyType} Copy</span>
                    <div class="payslip-header">
                        <div class="payslip-logo">
                            ${companyLogo ? `<img src="${companyLogo}" alt="Company Logo">` : '<div class="logo-placeholder"><span>AE</span></div>'}
                        </div>
                        <div class="payslip-company-details">
                            <h2>Apt Engineering Works Ltd</h2>
                            <p><strong>Payslip for Period:</strong> ${paymentDate}</p>
                            <p><strong>Employee:</strong> ${emp.name}</p>
                        </div>
                    </div>
                    <div class="payslip-meta">
                        <div><strong>Staff ID:</strong> ${emp.staffID}</div>
                        <div><strong>Bank:</strong> ${emp.bank}</div>
                        <div><strong>Account No:</strong> ${emp.account}</div>
                    </div>
                    
                    <table class="payslip-table">
                        <thead>
                            <tr>
                                <th>Earnings</th>
                                <th>Amount (NGN)</th>
                                <th>Deductions</th>
                                <th>Amount (NGN)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Base Pay</td>
                                <td>${formatCurrency(emp.basePay)}</td>
                                <td>PAYE Tax (${totals.payeRate}%)</td>
                                <td>${formatCurrency(totals.paye)}</td>
                            </tr>
                            <tr>
                                <td>Overtime</td>
                                <td>${formatCurrency(emp.overtime)}</td>
                                <td>Staff Pension (${totals.staffPensionRate}%)</td>
                                <td>${formatCurrency(totals.staffPension)}</td>
                            </tr>
                            <tr>
                                <td>Allowances</td>
                                <td>${formatCurrency(emp.allowances)}</td>
                                <td>Medicals (${totals.medicalsRate}%)</td>
                                <td>${formatCurrency(totals.medicals)}</td>
                            </tr>
                            <tr>
                                <td colspan="2"></td>
                                <td>Workmen Insurance (${totals.workmenRate}%)</td>
                                <td>${formatCurrency(totals.workmen)}</td>
                            </tr>
                            <tr>
                                <td colspan="2"></td>
                                <td>Other Deductions</td>
                                <td>${formatCurrency(emp.otherDeductions)}</td>
                            </tr>
                            <tr style="font-weight: bold;">
                                <td>Gross Pay</td>
                                <td>${formatCurrency(totals.grossPay)}</td>
                                <td>Total Deductions</td>
                                <td>${formatCurrency(totals.totalDeductions)}</td>
                            </tr>
                            <tr style="font-weight: bold; background-color: #f0f0f0;">
                                <td colspan="3" style="text-align: right;">Net Pay</td>
                                <td>${formatCurrency(totals.netPay)}</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="signature-section">
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <span>Employee Signature</span>
                        </div>
                        <div class="signature-box">
                            <div class="signature-line"></div>
                            <span>Company Signature</span>
                        </div>
                    </div>
                </div>
            `;
            
            return `
                <div class="payslip-page">
                    <div class="payslip-dual">
                        ${payslipContent('Company')}
                        ${payslipContent('Personnel')}
                    </div>
                </div>
            `;
        }).join('');

        payslipContainer.innerHTML = payslipsHTML;

        // Print the content of the payslip container
        window.print();
    };

    const updatePaymentDate = () => {
        paymentDate = document.getElementById('paymentDate').value;
        saveData();
    };

    const exportData = () => {
        const data = {
            employees: employees,
            history: history,
            deductionRates: {
                payePermanent: parseFloat(document.getElementById('payePermanent').value),
                payeContract: parseFloat(document.getElementById('payeContract').value),
                staffPensionPermanent: parseFloat(document.getElementById('staffPensionPermanent').value),
                companyPension: parseFloat(document.getElementById('companyPension').value),
                medicals: parseFloat(document.getElementById('medicals').value),
                workmen: parseFloat(document.getElementById('workmen').value),
            },
            paymentDate: paymentDate,
            logo: companyLogo
        };
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `apt-payroll-data-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };

    const importData = (e) => {
        const file = e.target.files[0];
        if (!file) {
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = JSON.parse(event.target.result);
                employees = data.employees || [];
                history = data.history || [];
                
                if (data.deductionRates) {
                    document.getElementById('payePermanent').value = data.deductionRates.payePermanent || 12;
                    document.getElementById('payeContract').value = data.deductionRates.payeContract || 5;
                    document.getElementById('staffPensionPermanent').value = data.deductionRates.staffPensionPermanent || 7.5;
                    document.getElementById('companyPension').value = data.deductionRates.companyPension || 15;
                    document.getElementById('medicals').value = data.deductionRates.medicals || 1;
                    document.getElementById('workmen').value = data.deductionRates.workmen || 1;
                }
                
                paymentDate = data.paymentDate || new Date().toISOString().split('T')[0];
                document.getElementById('paymentDate').value = paymentDate;
                
                if (data.logo) {
                    companyLogo = data.logo;
                    setLogo(companyLogo);
                } else {
                    companyLogo = null;
                    document.getElementById('companyLogo').innerHTML = '<span>AE</span>';
                }

                saveData();
                renderTable();
                renderHistory();
                alert("Data restored successfully!");
            } catch (err) {
                alert("Error restoring data: " + err.message);
            }
        };
        reader.readAsText(file);
        e.target.value = ''; // Reset file input
    };

    const renderHistory = () => {
        const historyGrid = document.getElementById('historyGrid');
        historyGrid.innerHTML = '';
        history.forEach((h, index) => {
            const card = document.createElement('div');
            card.className = 'history-card';
            card.innerHTML = `
                <div class="history-card-header">
                    <span class="history-card-title">Payroll for ${h.date}</span>
                    <span class="history-card-date">${h.employees.length} employees</span>
                </div>
                <div class="history-actions">
                    <button class="btn btn-info history-btn" onclick="restoreHistory(${index})">
                        <i class="fas fa-undo"></i> Restore
                    </button>
                    <button class="btn btn-danger history-btn" onclick="deleteHistory(${index})">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            `;
            historyGrid.appendChild(card);
        });
    };

    const saveToHistory = () => {
        const historyData = {
            date: paymentDate,
            employees: JSON.parse(JSON.stringify(employees)),
            deductionRates: {
                payePermanent: parseFloat(document.getElementById('payePermanent').value),
                payeContract: parseFloat(document.getElementById('payeContract').value),
                staffPensionPermanent: parseFloat(document.getElementById('staffPensionPermanent').value),
                companyPension: parseFloat(document.getElementById('companyPension').value),
                medicals: parseFloat(document.getElementById('medicals').value),
                workmen: parseFloat(document.getElementById('workmen').value),
            },
            logo: companyLogo
        };
        history.push(historyData);
        saveData();
        renderHistory();
        alert('Current payroll saved to history!');
    };

    const restoreHistory = (index) => {
        const h = history[index];
        const confirmRestore = window.confirm(`Are you sure you want to restore the payroll from ${h.date}? This will overwrite your current data.`);
        if (confirmRestore) {
            employees = JSON.parse(JSON.stringify(h.employees));
            document.getElementById('payePermanent').value = h.deductionRates.payePermanent;
            document.getElementById('payeContract').value = h.deductionRates.payeContract;
            document.getElementById('staffPensionPermanent').value = h.deductionRates.staffPensionPermanent;
            document.getElementById('companyPension').value = h.deductionRates.companyPension;
            document.getElementById('medicals').value = h.deductionRates.medicals;
            document.getElementById('workmen').value = h.deductionRates.workmen;
            paymentDate = h.date;
            document.getElementById('paymentDate').value = paymentDate;
            companyLogo = h.logo;
            setLogo(companyLogo);

            saveData();
            renderTable();
            renderSummary();
            alert('Payroll data restored successfully!');
        }
    };

    const deleteHistory = (index) => {
      const confirmDelete = window.confirm(`Are you sure you want to delete this payroll history entry?`);
      if (confirmDelete) {
        history.splice(index, 1);
        saveData();
        renderHistory();
        alert('History entry deleted.');
      }
    };
    
    const resetData = () => {
      if (window.confirm("This will permanently delete ALL payroll data (employees, history, settings). Continue?")) {
        localStorage.removeItem(localStorageKey);
        localStorage.removeItem('companyLogo');
        resetToDefaultData();
        renderTable();
        renderHistory();
        document.getElementById('paymentDate').value = paymentDate;
        alert("All data has been reset to default values");
      }
    };

    const switchTab = (tab) => {
        document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`${tab}Tab`).style.display = 'block';
        document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
    };

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        renderTable();
        renderHistory();
        document.getElementById('paymentDate').value = paymentDate;

        // Toggle event listeners
        document.getElementById('toggleDeductions').addEventListener('change', e => {
            const isChecked = e.target.checked;
            document.getElementById('deductionsPanel').style.display = isChecked ? 'grid' : 'none';
        });

        document.getElementById('toggleCalculated').addEventListener('change', e => {
            const table = document.getElementById("payrollTable");
            table.classList.toggle('hide-calculated', !e.target.checked);
        });

        // Event listener for mobile menu button
        const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
        const controls = document.querySelector('.controls');
        mobileMenuBtn.addEventListener('click', () => {
            controls.classList.toggle('active');
        });
    });
</script>
</body>
</html>
