<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apt Engineering Works Payroll System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e7f0 100%);
      padding: 12px;
      min-height: 100vh;
      font-size: 14px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header Styles - Mobile Optimized */
    header {
      background: linear-gradient(to right, #1a3a6c, #2c5282);
      color: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .header-content {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }
    .logo-container {
      background: white;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .logo-placeholder {
      width: 40px;
      height: 40px;
      background: linear-gradient(45deg, #2c5282, #1a3a6c);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 16px;
    }
    .logo-placeholder span {
      transform: rotate(-15deg);
    }
    .header-text {
      flex: 1;
      min-width: 0;
    }
    .header-text h1 {
      font-size: 18px;
      margin-bottom: 3px;
    }
    .header-text p {
      opacity: 0.9;
      font-size: 13px;
    }
    .controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      width: 100%;
    }
    .upload-btn {
      background: white;
      color: #2c5282;
      border: none;
      padding: 8px 10px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      font-size: 13px;
      flex: 1;
      min-width: 140px;
      justify-content: center;
    }
    .upload-btn:hover {
      background: #f0f4f8;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    #logoInput {
      display: none;
    }

    /* Mobile Navigation */
    .mobile-menu-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: block;
      padding: 5px;
    }

    /* Content Layout - Stacked on Mobile */
    .content {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    /* Panel Styles - Collapsible on Mobile */
    .panel {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 15px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .panel-header h2 {
      color: #2c5282;
      padding-bottom: 8px;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-content {
      margin-top: 15px;
    }
    .collapsed .panel-content {
      display: none;
    }
    .toggle-icon {
      transition: transform 0.3s;
    }
    .collapsed .toggle-icon {
      transform: rotate(180deg);
    }

    /* Form Styles */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .toggle-container label {
      font-weight: 500;
      color: #4a5568;
      font-size: 14px;
    }
    .deductions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #4a5568;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.3s;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
    }

    /* Button Styles - Larger for Mobile */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      font-size: 13px;
      flex: 1;
      min-width: 140px;
      justify-content: center;
    }
    .btn-primary {
      background: linear-gradient(to right, #3182ce, #2b6cb0);
      color: white;
    }
    .btn-success {
      background: linear-gradient(to right, #38a169, #2f855a);
      color: white;
    }
    .btn-warning {
      background: linear-gradient(to right, #ed8936, #dd6b20);
      color: white;
    }
    .btn-danger {
      background: linear-gradient(to right, #e53e3e, #c53030);
      color: white;
    }
    .btn-info {
      background: linear-gradient(to right, #00b5d8, #0987a0);
      color: white;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Table Styles - Scrollable on Mobile */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      margin-top: 10px;
      background: white;
      -webkit-overflow-scrolling: touch;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th {
      background: linear-gradient(to bottom, #2c5282, #1a3a6c);
      color: white;
      padding: 10px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
    }
    td {
      padding: 8px 6px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
      font-size: 12px;
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:nth-child(even) {
      background-color: #f8fafc;
    }

    /* Input Fields */
    .input-field {
      width: 100%;
      padding: 7px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      background: #fff9c4;
      font-size: 12px;
      min-width: 60px;
    }
    .calculated-value {
      width: 100%;
      padding: 7px;
      border: none;
      border-radius: 4px;
      background: #e0e0e0;
      font-weight: 500;
      font-size: 12px;
      text-align: center;
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Summary Section - Stacked on Mobile */
    .summary {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      font-weight: 600;
      color: #2d3748;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-around;
    }
    .summary-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px;
      min-width: 120px;
      flex: 1;
    }
    .summary-value {
      font-size: 14px;
      color: #2c5282;
      margin-top: 5px;
      white-space: nowrap;
    }

    /* Payslip Styles */
    .payslip-container {
      display: none;
    }
    .payslip-page {
      page-break-after: always;
      padding: 10px;
    }
    .payslip {
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 15px auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 100%;
      font-size: 12px;
    }
    .payslip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
      flex-wrap: wrap;
      gap: 10px;
    }
    .payslip-logo img {
      max-width: 80px;
      height: auto;
    }
    .payslip-company-details h2 {
      font-size: 15px;
      margin-bottom: 4px;
    }
    .payslip-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 5px;
    }
    .payslip-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 11px;
    }
    .payslip-table th,
    .payslip-table td {
      border: 1px solid #aaa;
      padding: 4px 6px;
      font-size: 10px;
    }
    .payslip-table th {
      background: #f0f0f0;
      font-weight: bold;
    }
    .confidential-footer {
      margin-top: 15px;
      text-align: center;
      font-size: 8px;
      color: #666;
      font-style: italic;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }
    .print-button {
      text-align: center;
      margin-top: 10px;
    }
    .signature-section {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    .signature-box {
      width: 48%;
      text-align: center;
    }
    .signature-line {
      height: 1px;
      background: #000;
      margin: 5px 0 10px;
    }
    .payslip-dual {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }
    .payslip-copy {
      width: 48%;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      position: relative;
    }
    .copy-label {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #f0f0f0;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: bold;
    }

    /* Print Styles */
    @media print {
      body {
        background: white;
        color: black;
        font-size: 12px;
        margin: 0;
        padding: 0;
      }
      body > *:not(.payslip-container) {
        display: none !important;
      }
      .payslip-container {
        display: block !important;
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      .payslip-page {
        width: 100%;
        page-break-after: always;
        margin: 0;
        padding: 0;
      }
      .payslip {
        width: 100%;
        margin: 0;
        box-shadow: none;
        border: none;
        padding: 10px;
      }
      .payslip-table th,
      .payslip-table td {
        border: 1px solid #000;
      }
      .print-button {
        display: none;
      }
      .confidential-footer {
        font-size: 8px;
      }
      .signature-section {
        display: flex;
      }
      .signature-box {
        width: 48%;
      }
      .payslip-dual {
        display: flex;
        gap: 15px;
      }
      .payslip-copy {
        width: 48%;
        border: 1px solid #000;
      }
      @page {
        size: A4 landscape;
        margin: 1cm;
      }
    }

    /* Toggle for Calculated Fields */
    #payrollTable.hide-calculated .calculated-cell {
      display: none;
    }
    #payrollTable.hide-calculated .input-field {
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      width: auto;
    }
    #payrollTable.hide-calculated td:not(.calculated-cell)) {
      width: auto;
    }

    /* History Panel Styles */
    .history-panel {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .history-header h2 {
      color: #2c5282;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }
    .history-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #2c5282;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .history-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .history-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }
    .history-card-title {
      font-weight: 600;
      color: #2c5282;
      font-size: 15px;
    }
    .history-card-date {
      font-size: 12px;
      color: #718096;
    }
    .history-card-body {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .history-card-item {
      margin-bottom: 5px;
    }
    .history-card-label {
      font-size: 11px;
      color: #718096;
      font-weight: 500;
    }
    .history-card-value {
      font-size: 13px;
      font-weight: 600;
      color: #2d3748;
    }
    .history-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .history-btn {
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .history-btn i {
      font-size: 10px;
    }

    /* Payment Date Selector */
    .payment-date-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    .payment-date-selector label {
      font-weight: 500;
      color: #4a5568;
      white-space: nowrap;
    }
    .payment-date-selector input {
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 13px;
    }

    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 15px;
    }
    .tab-btn {
      padding: 10px 15px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab-btn.active {
      color: #2c5282;
      border-bottom-color: #2c5282;
    }
    .tab-btn:hover:not(.active) {
      color: #3182ce;
      border-bottom-color: #bee3f8;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }

    /* Mobile-specific Styles */
    @media (max-width: 480px) {
      body {
        padding: 8px;
      }
      .header-text h1 {
        font-size: 16px;
      }
      .header-text p {
        font-size: 12px;
      }
      .logo-placeholder {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }
      .panel-header h2 {
        font-size: 16px;
      }
      .summary {
        flex-direction: column;
        gap: 8px;
      }
      .summary-item {
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
        padding: 8px;
        background: #f8fafc;
        border-radius: 6px;
      }
      .action-buttons {
        flex-direction: column;
      }
      .btn {
        width: 100%;
      }
      .controls {
        gap: 5px;
      }
      .upload-btn {
        min-width: 0;
      }
      .history-grid {
        grid-template-columns: 1fr;
      }
      .payment-date-selector {
        flex-direction: column;
        align-items: flex-start;
      }
      .tab-navigation {
        overflow-x: auto;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Tablet Styles */
    @media (min-width: 768px) {
      .content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
      }
      .panel {
        margin-bottom: 0;
      }
      header {
        flex-direction: row;
        justify-content: space-between;
      }
      .controls {
        width: auto;
        margin-top: 0;
      }
    }

    /* Desktop Styles */
    @media (min-width: 992px) {
      .content {
        grid-template-columns: 1fr 1.8fr;
      }
      .mobile-menu-btn {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-content">
        <button class="mobile-menu-btn">
          <i class="fas fa-bars"></i>
        </button>
        <div class="logo-container">
          <div class="logo-placeholder" id="companyLogo">
            <span>AE</span>
          </div>
        </div>
        <div class="header-text">
          <h1>Apt Engineering Works Ltd</h1>
          <p>Advanced Payroll Management System</p>
        </div>
      </div>
      <div class="controls">
        <button class="upload-btn" onclick="document.getElementById('logoInput').click()">
          <i class="fas fa-upload"></i> Upload Logo
        </button>
        <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(event)">
      </div>
    </header>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-btn active" onclick="switchTab('current')">
        <i class="fas fa-file-invoice-dollar"></i> Current Payroll
      </button>
      <button class="tab-btn" onclick="switchTab('history')">
        <i class="fas fa-history"></i> Payment History
      </button>
      <button class="tab-btn" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i> Settings
      </button>
    </div>

    <!-- Current Payroll Tab -->
    <div id="currentTab" class="tab-content active">
      <div class="content">
        <div class="panel">
          <div class="panel-header" onclick="togglePanel(this)">
            <h2><i class="fas fa-cog"></i> Deduction Settings</h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="panel-content">
            <div class="payment-date-selector">
              <label for="paymentDate"><i class="far fa-calendar-alt"></i> Payment Date:</label>
              <input type="date" id="paymentDate" onchange="updatePaymentDate()">
            </div>
            <div class="toggle-container">
              <input type="checkbox" id="toggleDeductions" checked>
              <label for="toggleDeductions">Show Deduction Rates</label>
            </div>
            <div class="toggle-container">
              <input type="checkbox" id="toggleCalculated" checked>
              <label for="toggleCalculated">Show Calculated Fields</label>
            </div>
            <div class="deductions-grid" id="deductionsPanel">
              <!-- Deduction Fields -->
              <div class="form-group">
                <label><i class="fas fa-percent"></i> PAYE - Permanent (%)</label>
                <input type="number" id="payePermanent" value="12" step="0.1">
              </div>
              <div class="form-group">
                <label><i class="fas fa-percent"></i> PAYE - Contract (%)</label>
                <input type="number" id="payeContract" value="5" step="0.1">
              </div>
              <div class="form-group">
                <label><i class="fas fa-money-bill-wave"></i> Staff Pension - Permanent (%)</label>
                <input type="number" id="staffPensionPermanent" value="7.5" step="0.1">
              </div>
              <div class="form-group">
                <label><i class="fas fa-building"></i> Company Pension (%)</label>
                <input type="number" id="companyPension" value="15" step="0.1">
              </div>
              <div class="form-group">
                <label><i class="fas fa-heartbeat"></i> Medicals Insurance (%)</label>
                <input type="number" id="medicals" value="1" step="0.1">
              </div>
              <div class="form-group">
                <label><i class="fas fa-hard-hat"></i> Workmen Insurance (%)</label>
                <input type="number" id="workmen" value="1" step="0.1">
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn btn-warning" onclick="addEmployee()">
                <i class="fas fa-user-plus"></i> Add Employee
              </button>
              <button class="btn btn-success" onclick="exportCSV()">
                <i class="fas fa-file-export"></i> Export CSV
              </button>
              <button class="btn btn-primary" onclick="savePayrollRun()">
                <i class="fas fa-save"></i> Save Payroll Run
              </button>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header" onclick="togglePanel(this)">
            <h2><i class="fas fa-users"></i> Employee List <span class="employee-count" id="employeeCount">0</span></h2>
            <i class="fas fa-chevron-down toggle-icon"></i>
          </div>
          <div class="panel-content">
            <div class="table-container">
              <table id="payrollTable">
                <thead>
                  <tr>
                    <th>Name</th><th>ID No</th><th>Status</th><th>Days</th><th>Basic</th>
                    <th>Transport</th><th>Housing</th><th>IOU</th>
                    <th class="calculated-cell">Gross Pay</th><th class="calculated-cell">Net Pay</th>
                    <th class="calculated-cell">Personnel Cost</th><th class="calculated-cell">External</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="summary" id="summary">
        <div class="summary-item">
          <div><i class="fas fa-users"></i> Total Employees</div>
          <div class="summary-value" id="totalEmployees">0</div>
        </div>
        <div class="summary-item">
          <div><i class="fas fa-money-bill-wave"></i> Total Gross Pay</div>
          <div class="summary-value" id="totalGross">₦0.00</div>
        </div>
        <div class="summary-item">
          <div><i class="fas fa-wallet"></i> Total Net Pay</div>
          <div class="summary-value" id="totalNet">₦0.00</div>
        </div>
        <div class="summary-item">
          <div><i class="fas fa-building"></i> Total Personnel Cost</div>
          <div class="summary-value" id="totalPersonnel">₦0.00</div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
      <div class="history-panel">
        <div class="history-header">
          <h2><i class="fas fa-history"></i> Payroll History</h2>
          <div class="form-group" style="width: 200px;">
            <select id="historyFilter" class="input-field" onchange="filterHistory()">
              <option value="all">All Months</option>
              <option value="last3">Last 3 Months</option>
              <option value="last6">Last 6 Months</option>
              <option value="year">This Year</option>
            </select>
          </div>
        </div>
        <div class="history-grid" id="historyContainer">
          <!-- History cards will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="tab-content">
      <div class="panel">
        <div class="panel-header">
          <h2><i class="fas fa-user-tie"></i> Manager Settings</h2>
        </div>
        <div class="panel-content">
          <div class="form-group">
            <label for="managerName"><i class="fas fa-signature"></i> Manager Name for Payslips</label>
            <input type="text" id="managerName" value="John Manager" onchange="updateManagerName(this.value)">
          </div>
          <div class="form-group">
            <label><i class="fas fa-database"></i> Data Management</label>
            <div class="action-buttons">
              <button class="btn btn-info" onclick="backupData()">
                <i class="fas fa-file-export"></i> Backup Data
              </button>
              <button class="btn btn-warning" onclick="restoreData()">
                <i class="fas fa-file-import"></i> Restore Data
              </button>
              <button class="btn btn-danger" onclick="resetData()">
                <i class="fas fa-trash-alt"></i> Reset All Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Payslip Template -->
  <div class="payslip-container" id="payslipContainer"></div>

  <!-- Hidden file input for data restore -->
  <input type="file" id="restoreFileInput" accept=".json" style="display: none;">

  <script>
    let employees = [];
    let payrollHistory = [];
    let companyLogo = null;
    let lastValues = {};
    let managerName = "John Manager";
    let currentPaymentDate = new Date().toISOString().split('T')[0];
    const localStorageKey = "aptEngineeringPayrollData";

    // Initialize the app
    window.onload = () => {
      loadData();
      document.getElementById('paymentDate').value = currentPaymentDate;
      document.getElementById('deductionsPanel').style.display = 'grid';
      renderTable();
      renderHistory();
      const savedLogo = localStorage.getItem('companyLogo');
      if (savedLogo) setLogo(savedLogo);
    };

    function loadData() {
      const savedData = localStorage.getItem(localStorageKey);
      if (savedData) {
        try {
          const parsedData = JSON.parse(savedData);
          employees = parsedData.employees || [];
          payrollHistory = parsedData.payrollHistory || [];
          managerName = parsedData.managerName || "John Manager";
          currentPaymentDate = parsedData.currentPaymentDate || new Date().toISOString().split('T')[0];
        } catch (e) {
          console.error("Error loading saved data", e);
          resetToDefaultData();
        }
      } else {
        resetToDefaultData();
      }
    }

    function resetToDefaultData() {
      employees = [
        { name: "Abe Abiola", idNo: "AEWP-001", status: "Permanent", daysWorked: 22, basic: 35000, transport: 15000, housing: 15000, iou: 0 },
        { name: "Jeremiah Dennis", idNo: "AEWP-004", status: "Contract", daysWorked: 16, basic: 60000, transport: 3500, housing: 0, iou: 0 },
        { name: "Chinwe Okonkwo", idNo: "AEWP-007", status: "Permanent", daysWorked: 20, basic: 42000, transport: 12000, housing: 18000, iou: 5000 },
        { name: "Oluwaseun Adebayo", idNo: "AEWP-012", status: "Contract", daysWorked: 18, basic: 55000, transport: 8000, housing: 0, iou: 2500 }
      ];
      payrollHistory = [];
      managerName = "John Manager";
      currentPaymentDate = new Date().toISOString().split('T')[0];
    }

    function saveData() {
      const data = {
        employees: employees,
        payrollHistory: payrollHistory,
        managerName: managerName,
        currentPaymentDate: currentPaymentDate
      };
      localStorage.setItem(localStorageKey, JSON.stringify(data));
    }

    function togglePanel(element) {
      const panel = element.closest('.panel');
      panel.classList.toggle('collapsed');
    }

    function switchTab(tabId) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      // Deactivate all tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      // Show selected tab
      document.getElementById(tabId + 'Tab').classList.add('active');
      // Activate clicked button
      event.currentTarget.classList.add('active');
      
      // Special handling for history tab
      if (tabId === 'history') {
        renderHistory();
      }
    }

    function updatePaymentDate() {
      currentPaymentDate = document.getElementById('paymentDate').value;
      saveData();
    }

    function updateManagerName(name) {
      managerName = name;
      saveData();
    }

    function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const logoData = e.target.result;
        setLogo(logoData);
        localStorage.setItem('companyLogo', logoData);
      };
      reader.readAsDataURL(file);
    }

    function setLogo(logoData) {
      companyLogo = logoData;
      const logoElement = document.getElementById('companyLogo');
      logoElement.innerHTML = '';
      logoElement.style.backgroundImage = `url(${logoData})`;
      logoElement.style.backgroundSize = 'contain';
      logoElement.style.backgroundPosition = 'center';
      logoElement.style.backgroundRepeat = 'no-repeat';
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      employees.forEach((emp, index) => {
        const gross = calculateGross(emp);
        const deductions = calculateDeductions(emp, gross);
        const net = calculateNet(emp, gross, deductions);
        const personnelCost = deductions.staffPension + deductions.companyPension;
        const empKey = `${index}-gross`;
        const hasChanged = lastValues[empKey] !== gross;
        if (hasChanged) lastValues[empKey] = gross;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input class="input-field" type="text" value="${emp.name}" onchange="updateField(${index}, 'name', this.value)"></td>
          <td><input class="input-field" type="text" value="${emp.idNo}" onchange="updateField(${index}, 'idNo', this.value)"></td>
          <td>
            <select class="input-field" onchange="updateField(${index}, 'status', this.value)">
              <option ${emp.status === "Permanent" ? "selected" : ""}>Permanent</option>
              <option ${emp.status === "Contract" ? "selected" : ""}>Contract</option>
            </select>
          </td>
          <td><input class="input-field" type="number" value="${emp.daysWorked}" onchange="updateField(${index}, 'daysWorked', parseFloat(this.value))"></td>
          <td><input class="input-field" type="number" value="${emp.basic}" onchange="updateField(${index}, 'basic', parseFloat(this.value))"></td>
          <td><input class="input-field" type="number" value="${emp.transport}" onchange="updateField(${index}, 'transport', parseFloat(this.value))"></td>
          <td><input class="input-field" type="number" value="${emp.housing}" onchange="updateField(${index}, 'housing', parseFloat(this.value))"></td>
          <td><input class="input-field" type="number" value="${emp.iou}" onchange="updateField(${index}, 'iou', parseFloat(this.value))"></td>
          <td class="calculated-cell"><div class="calculated-value ${hasChanged ? 'changed' : ''}">${formatCurrency(gross)}</div></td>
          <td class="calculated-cell"><div class="calculated-value">${formatCurrency(net)}</div></td>
          <td class="calculated-cell"><div class="calculated-value">${formatCurrency(personnelCost)}</div></td>
          <td class="calculated-cell"><div class="calculated-value">${formatCurrency(net)}</div></td>
          <td class="actions-cell">
            <button class="btn btn-primary action-btn" onclick="generatePayslip(${index})">
              <i class="fas fa-file-alt"></i> Slip
            </button>
            <button class="btn btn-danger action-btn" onclick="deleteEmployee(${index})">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
      updateSummary();
      document.getElementById('employeeCount').textContent = employees.length;
      saveData();
    }

    function deleteEmployee(index) {
      if (confirm("Are you sure you want to delete this employee record?")) {
        employees.splice(index, 1);
        renderTable();
      }
    }

    function updateField(index, field, value) {
      employees[index][field] = value;
      renderTable();
    }

    function calculateGross(emp) {
      return emp.status === "Permanent"
        ? (emp.basic + emp.transport + emp.housing) * emp.daysWorked
        : (emp.basic + emp.transport) * emp.daysWorked;
    }

    function calculateDeductions(emp, gross) {
      const payeRate = emp.status === "Permanent"
        ? parseFloat(document.getElementById("payePermanent").value) / 100
        : parseFloat(document.getElementById("payeContract").value) / 100;
      const staffPensionRate = emp.status === "Permanent"
        ? parseFloat(document.getElementById("staffPensionPermanent").value) / 100
        : 0;
      const companyPensionRate = parseFloat(document.getElementById("companyPension").value) / 100;
      const medicalsRate = parseFloat(document.getElementById("medicals").value) / 100;
      const workmenRate = parseFloat(document.getElementById("workmen").value) / 100;
      return {
        paye: gross * payeRate,
        staffPension: gross * staffPensionRate,
        companyPension: gross * companyPensionRate,
        medicals: gross * medicalsRate,
        workmen: gross * workmenRate
      };
    }

    function calculateNet(emp, gross, deductions) {
      const totalDeductions = deductions.paye + deductions.staffPension + deductions.medicals + deductions.workmen;
      return emp.status === "Permanent"
        ? gross - totalDeductions - emp.iou
        : gross - totalDeductions - emp.iou;
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(value || 0);
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function addEmployee() {
      employees.push({
        name: "New Employee",
        idNo: `AEWP-${String(employees.length + 1).padStart(3, '0')}`,
        status: "Permanent",
        daysWorked: 22,
        basic: 30000,
        transport: 10000,
        housing: 12000,
        iou: 0
      });
      renderTable();
    }

    function exportCSV() {
      const now = new Date();
      const month = now.toLocaleString('default', { month: 'long' });
      const year = now.getFullYear();
      let csv = "Name,ID No,Status,Days Worked,Basic,Transport,Housing,IOU,Gross Pay,Net Pay,Personnel Cost,External Payment\n";
      employees.forEach(emp => {
        const gross = calculateGross(emp);
        const deductions = calculateDeductions(emp, gross);
        const net = calculateNet(emp, gross, deductions);
        const personnelCost = deductions.staffPension + deductions.companyPension;
        csv += `"${emp.name}","${emp.idNo}","${emp.status}",${emp.daysWorked},${emp.basic},${emp.transport},${emp.housing},${emp.iou},${gross},${net},${personnelCost},${net}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `apt_engineering_payroll_${new Date().toLocaleString('default', { month: 'long' })}_${new Date().getFullYear()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function updateSummary() {
      const totalEmployees = employees.length;
      const totalGross = employees.reduce((sum, emp) => sum + calculateGross(emp), 0);
      const totalNet = employees.reduce((sum, emp) => {
        const gross = calculateGross(emp);
        const deductions = calculateDeductions(emp, gross);
        return sum + calculateNet(emp, gross, deductions);
      }, 0);
      const totalPersonnelCost = employees.reduce((sum, emp) => {
        const gross = calculateGross(emp);
        const deductions = calculateDeductions(emp, gross);
        return sum + (deductions.staffPension + deductions.companyPension);
      }, 0);
      document.getElementById("totalEmployees").textContent = totalEmployees;
      document.getElementById("totalGross").textContent = formatCurrency(totalGross);
      document.getElementById("totalNet").textContent = formatCurrency(totalNet);
      document.getElementById("totalPersonnel").textContent = formatCurrency(totalPersonnelCost);
    }

    function savePayrollRun() {
      if (!currentPaymentDate) {
        alert("Please select a payment date first");
        return;
      }
      
      const payrollRun = {
        id: Date.now(),
        date: currentPaymentDate,
        employees: JSON.parse(JSON.stringify(employees)),
        totals: {
          employees: employees.length,
          gross: employees.reduce((sum, emp) => sum + calculateGross(emp), 0),
          net: employees.reduce((sum, emp) => {
            const gross = calculateGross(emp);
            const deductions = calculateDeductions(emp, gross);
            return sum + calculateNet(emp, gross, deductions);
          }, 0),
          personnelCost: employees.reduce((sum, emp) => {
            const gross = calculateGross(emp);
            const deductions = calculateDeductions(emp, gross);
            return sum + (deductions.staffPension + deductions.companyPension);
          }, 0)
        },
        deductions: {
          payePermanent: parseFloat(document.getElementById("payePermanent").value),
          payeContract: parseFloat(document.getElementById("payeContract").value),
          staffPensionPermanent: parseFloat(document.getElementById("staffPensionPermanent").value),
          companyPension: parseFloat(document.getElementById("companyPension").value),
          medicals: parseFloat(document.getElementById("medicals").value),
          workmen: parseFloat(document.getElementById("workmen").value)
        }
      };
      
      payrollHistory.unshift(payrollRun);
      saveData();
      renderHistory();
      alert(`Payroll run for ${formatDate(currentPaymentDate)} saved successfully!`);
    }

    function renderHistory() {
      const container = document.getElementById("historyContainer");
      container.innerHTML = "";
      
      // Filter history based on selected option
      const filter = document.getElementById("historyFilter").value;
      let filteredHistory = [...payrollHistory];
      
      const now = new Date();
      const currentYear = now.getFullYear();
      
      if (filter === "last3") {
        const threeMonthsAgo = new Date();
        threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
        filteredHistory = payrollHistory.filter(run => new Date(run.date) >= threeMonthsAgo);
      } else if (filter === "last6") {
        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        filteredHistory = payrollHistory.filter(run => new Date(run.date) >= sixMonthsAgo);
      } else if (filter === "year") {
        filteredHistory = payrollHistory.filter(run => new Date(run.date).getFullYear() === currentYear);
      }
      
      if (filteredHistory.length === 0) {
        container.innerHTML = `<div style="grid-column: 1 / -1; text-align: center; padding: 20px; color: #718096;">
          <i class="fas fa-inbox" style="font-size: 24px; margin-bottom: 10px;"></i>
          <p>No payroll history found for the selected filter</p>
        </div>`;
        return;
      }
      
      filteredHistory.forEach(run => {
        const card = document.createElement("div");
        card.className = "history-card";
        card.innerHTML = `
          <div class="history-card-header">
            <div class="history-card-title">${formatDate(run.date)}</div>
            <div class="history-card-date">${run.employees.length} employees</div>
          </div>
          <div class="history-card-body">
            <div class="history-card-item">
              <div class="history-card-label">Total Gross Pay</div>
              <div class="history-card-value">${formatCurrency(run.totals.gross)}</div>
            </div>
            <div class="history-card-item">
              <div class="history-card-label">Total Net Pay</div>
              <div class="history-card-value">${formatCurrency(run.totals.net)}</div>
            </div>
            <div class="history-card-item">
              <div class="history-card-label">Personnel Cost</div>
              <div class="history-card-value">${formatCurrency(run.totals.personnelCost)}</div>
            </div>
            <div class="history-card-item">
              <div class="history-card-label">PAYE Rate</div>
              <div class="history-card-value">${run.deductions.payePermanent}% / ${run.deductions.payeContract}%</div>
            </div>
          </div>
          <div class="history-actions">
            <button class="history-btn" style="background: #ebf8ff; color: #3182ce;" onclick="viewPayrollRun('${run.id}')">
              <i class="fas fa-eye"></i> View
            </button>
            <button class="history-btn" style="background: #feebc8; color: #dd6b20;" onclick="reusePayrollRun('${run.id}')">
              <i class="fas fa-redo"></i> Reuse
            </button>
            <button class="history-btn" style="background: #fff5f5; color: #e53e3e;" onclick="deletePayrollRun('${run.id}')">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function filterHistory() {
      renderHistory();
    }

    function viewPayrollRun(id) {
      const run = payrollHistory.find(r => r.id.toString() === id);
      if (!run) return;
      
      // Create a temporary employees array
      const tempEmployees = [...employees];
      employees = run.employees;
      
      // Set the payment date
      currentPaymentDate = run.date;
      document.getElementById('paymentDate').value = currentPaymentDate;
      
      // Set the deduction rates
      document.getElementById('payePermanent').value = run.deductions.payePermanent;
      document.getElementById('payeContract').value = run.deductions.payeContract;
      document.getElementById('staffPensionPermanent').value = run.deductions.staffPensionPermanent;
      document.getElementById('companyPension').value = run.deductions.companyPension;
      document.getElementById('medicals').value = run.deductions.medicals;
      document.getElementById('workmen').value = run.deductions.workmen;
      
      // Render the table
      renderTable();
      
      // Switch to current payroll tab
      switchTab('current');
      
      // Restore original employees array after a delay
      setTimeout(() => {
        employees = tempEmployees;
      }, 100);
      
      alert(`Viewing payroll run from ${formatDate(run.date)}. Changes will not be saved unless you click "Save Payroll Run".`);
    }

    function reusePayrollRun(id) {
      if (!confirm("This will replace your current payroll data with this historical run. Continue?")) return;
      
      const run = payrollHistory.find(r => r.id.toString() === id);
      if (!run) return;
      
      employees = JSON.parse(JSON.stringify(run.employees));
      currentPaymentDate = new Date().toISOString().split('T')[0];
      document.getElementById('paymentDate').value = currentPaymentDate;
      
      // Set the deduction rates
      document.getElementById('payePermanent').value = run.deductions.payePermanent;
      document.getElementById('payeContract').value = run.deductions.payeContract;
      document.getElementById('staffPensionPermanent').value = run.deductions.staffPensionPermanent;
      document.getElementById('companyPension').value = run.deductions.companyPension;
      document.getElementById('medicals').value = run.deductions.medicals;
      document.getElementById('workmen').value = run.deductions.workmen;
      
      renderTable();
      switchTab('current');
    }

    function deletePayrollRun(id) {
      if (!confirm("Are you sure you want to delete this payroll run? This cannot be undone.")) return;
      
      payrollHistory = payrollHistory.filter(r => r.id.toString() !== id);
      saveData();
      renderHistory();
    }

    function generatePayslip(index) {
      const emp = employees[index];
      const gross = calculateGross(emp);
      const deductions = calculateDeductions(emp, gross);
      const totalDeductions = deductions.paye + deductions.staffPension + deductions.medicals + deductions.workmen + emp.iou;
      const net = calculateNet(emp, gross, deductions);
      const now = new Date();
      const month = now.toLocaleString('default', { month: 'long' });
      const dateStr = now.toLocaleDateString();
      const container = document.getElementById("payslipContainer");
      
      container.innerHTML = `
        <div class="payslip-page">
          <div class="payslip">
            <div class="payslip-header">
              <div class="payslip-logo">
                <img src="${companyLogo || ''}" alt="Company Logo">
              </div>
              <div class="payslip-company-details">
                <h2>Apt Engineering Works Ltd</h2>
                <p>Payroll Department</p>
                <p>Lagos, Nigeria</p>
              </div>
            </div>
            <div class="payslip-meta">
              <div><strong>Month:</strong> ${month}</div>
              <div><strong>Payment Date:</strong> ${formatDate(currentPaymentDate)}</div>
              <div><strong>Generated on:</strong> ${dateStr}</div>
            </div>
            <table class="payslip-table">
              <tr><th>Employee Name:</th><td>${emp.name}</td></tr>
              <tr><th>ID Number:</th><td>${emp.idNo}</td></tr>
              <tr><th>Status:</th><td>${emp.status}</td></tr>
              <tr><th>Days Worked:</th><td>${emp.daysWorked}</td></tr>
            </table>
            
            <div class="payslip-dual">
              <div class="payslip-copy">
                <div class="copy-label">COMPANY COPY</div>
                <h4 style="margin: 10px 0 5px;">Earnings</h4>
                <table class="payslip-table">
                  <tr><td>Basic Pay</td><td>${formatCurrency(emp.basic)}</td></tr>
                  <tr><td>Transport Allowance</td><td>${formatCurrency(emp.transport)}</td></tr>
                  <tr><td>Housing Allowance</td><td>${formatCurrency(emp.housing)}</td></tr>
                  <tr><th>Gross Pay</th><td>${formatCurrency(gross)}</td></tr>
                </table>
                <h4 style="margin: 10px 0 5px;">Deductions</h4>
                <table class="payslip-table">
                  <tr><td>PAYE</td><td>${formatCurrency(deductions.paye)}</td></tr>
                  <tr><td>Staff Pension</td><td>${formatCurrency(deductions.staffPension)}</td></tr>
                  <tr><td>Medicals Insurance</td><td>${formatCurrency(deductions.medicals)}</td></tr>
                  <tr><td>Workmen Insurance</td><td>${formatCurrency(deductions.workmen)}</td></tr>
                  <tr><td>IOU</td><td>${formatCurrency(emp.iou)}</td></tr>
                  <tr><th>Total Deductions</th><td>${formatCurrency(totalDeductions)}</td></tr>
                </table>
                <h4 style="margin: 10px 0 5px;">Net Pay</h4>
                <h2 style="text-align: center; color: #2c5282;">${formatCurrency(net)}</h2>
              </div>
              
              <div class="payslip-copy">
                <div class="copy-label">STAFF COPY</div>
                <h4 style="margin: 10px 0 5px;">Earnings</h4>
                <table class="payslip-table">
                  <tr><td>Basic Pay</td><td>${formatCurrency(emp.basic)}</td></tr>
                  <tr><td>Transport Allowance</td><td>${formatCurrency(emp.transport)}</td></tr>
                  <tr><td>Housing Allowance</td><td>${formatCurrency(emp.housing)}</td></tr>
                  <tr><th>Gross Pay</th><td>${formatCurrency(gross)}</td></tr>
                </table>
                <h4 style="margin: 10px 0 5px;">Deductions</h4>
                <table class="payslip-table">
                  <tr><td>PAYE</td><td>${formatCurrency(deductions.paye)}</td></tr>
                  <tr><td>Staff Pension</td><td>${formatCurrency(deductions.staffPension)}</td></tr>
                  <tr><td>Medicals Insurance</td><td>${formatCurrency(deductions.medicals)}</td></tr>
                  <tr><td>Workmen Insurance</td><td>${formatCurrency(deductions.workmen)}</td></tr>
                  <tr><td>IOU</td><td>${formatCurrency(emp.iou)}</td></tr>
                  <tr><th>Total Deductions</th><td>${formatCurrency(totalDeductions)}</td></tr>
                </table>
                <h4 style="margin: 10px 0 5px;">Net Pay</h4>
                <h2 style="text-align: center; color: #2c5282;">${formatCurrency(net)}</h2>
              </div>
            </div>
            
            <div class="signature-section">
              <div class="signature-box">
                <div>Manager Name: ${managerName}</div>
                <div class="signature-line"></div>
                <div>Manager Signature</div>
              </div>
              <div class="signature-box">
                <div>Staff Name: ${emp.name}</div>
                <div class="signature-line"></div>
                <div>Staff Signature</div>
              </div>
            </div>
            
            <div class="confidential-footer">
              This document contains confidential information and should be treated as such.
            </div>
            <div class="print-button">
              <button class="btn btn-primary" onclick="printPayslip()">
                <i class="fas fa-print"></i> Print Payslip
              </button>
            </div>
          </div>
        </div>
      `;
      container.style.display = 'block';
    }

    function printPayslip() {
      window.print();
    }

    function backupData() {
      const data = {
        employees: employees,
        payrollHistory: payrollHistory,
        managerName: managerName,
        currentPaymentDate: currentPaymentDate,
        logo: localStorage.getItem('companyLogo')
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `apt_engineering_payroll_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreData() {
      document.getElementById('restoreFileInput').click();
    }

    document.getElementById('restoreFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (!confirm(`This will replace all current data with the backup. Continue?\n\nBackup contains:\n- ${data.employees.length} employees\n- ${data.payrollHistory.length} historical runs`)) {
            return;
          }
          
          employees = data.employees || [];
          payrollHistory = data.payrollHistory || [];
          managerName = data.managerName || "John Manager";
          currentPaymentDate = data.currentPaymentDate || new Date().toISOString().split('T')[0];
          
          if (data.logo) {
            setLogo(data.logo);
            localStorage.setItem('companyLogo', data.logo);
          }
          
          saveData();
          renderTable();
          renderHistory();
          document.getElementById('paymentDate').value = currentPaymentDate;
          alert("Data restored successfully!");
        } catch (err) {
          alert("Error restoring data: " + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = ''; // Reset file input
    });

    function resetData() {
      if (!confirm("This will permanently delete ALL payroll data (employees, history, settings). Continue?")) return;
      
      localStorage.removeItem(localStorageKey);
      localStorage.removeItem('companyLogo');
      resetToDefaultData();
      renderTable();
      renderHistory();
      document.getElementById('paymentDate').value = currentPaymentDate;
      alert("All data has been reset to default values");
    }

    // Initialize toggle events
    document.getElementById('toggleDeductions').addEventListener('change', e => {
      document.getElementById('deductionsPanel').style.display = e.target.checked ? 'grid' : 'none';
    });

    document.getElementById('toggleCalculated').addEventListener('change', e => {
      const table = document.getElementById("payrollTable");
      table.classList.toggle('hide-calculated', !e.target.checked);
    });
  </script>
</body>
</html>