<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apt Engineering Works Payroll System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e7f0 100%);
      padding: 12px;
      min-height: 100vh;
      font-size: 14px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    /* Header Styles */
    header {
      background: linear-gradient(to right, #1a3a6c, #2c5282);
      color: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      margin-bottom: 15px;
    }
    header h1 {
      font-size: 18px;
    }
    header p {
      opacity: 0.9;
      font-size: 13px;
    }
    /* Tab Navigation */
    .tab-navigation {
      display: flex;
      border-bottom: 1px solid #e2e8f0;
      margin-bottom: 15px;
    }
    .tab-btn {
      padding: 10px 15px;
      background: none;
      border: none;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.3s;
    }
    .tab-btn.active {
      color: #2c5282;
      border-bottom-color: #2c5282;
    }
    .tab-btn:hover:not(.active) {
      color: #3182ce;
      border-bottom-color: #bee3f8;
    }
    /* Panel Styles */
    .panel {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 15px;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .panel-header h2 {
      color: #2c5282;
      padding-bottom: 8px;
      font-size: 17px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-content {
      margin-top: 15px;
    }
    /* Form Styles */
    .payment-date-selector {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
    }
    .payment-date-selector label {
      font-weight: 500;
      color: #4a5568;
      white-space: nowrap;
    }
    .payment-date-selector input {
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 13px;
    }
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .toggle-container label {
      font-weight: 500;
      color: #4a5568;
      font-size: 14px;
    }
    .deductions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #4a5568;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 13px;
      transition: border-color 0.3s;
    }
    .contact-selector {
      display: flex;
      gap: 5px;
      margin-top: 2px;
    }
    .contact-selector button {
      padding: 4px 8px;
      background: #e2e8f0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    /* Button Styles */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      font-size: 13px;
      flex: 1;
      min-width: 140px;
      justify-content: center;
    }
    .btn-primary { background: linear-gradient(to right, #3182ce, #2b6cb0); color: white; }
    .btn-success { background: linear-gradient(to right, #38a169, #2f855a); color: white; }
    .btn-warning { background: linear-gradient(to right, #ed8936, #dd6b20); color: white; }
    .btn-danger { background: linear-gradient(to right, #e53e3e, #c53030); color: white; }
    .btn-info { background: linear-gradient(to right, #00b5d8, #0987a0); color: white; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }

    /* Table Styles */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      margin-top: 10px;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    th {
      background: linear-gradient(to bottom, #2c5282, #1a3a6c);
      color: white;
      padding: 10px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
    }
    td {
      padding: 8px 6px;
      border-bottom: 1px solid #e2e8f0;
      text-align: center;
      font-size: 12px;
    }
    tr:nth-child(even) { background-color: #f8fafc; }

    /* Input Fields */
    .input-field {
      width: 100%;
      padding: 7px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      background: #fff9c4;
      font-size: 12px;
    }
    .calculated-value {
      width: 100%;
      padding: 7px;
      border: none;
      border-radius: 4px;
      background: #e0e0e0;
      font-weight: 500;
      font-size: 12px;
      text-align: center;
    }

    /* Summary Section */
    .summary {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-around;
    }
    .summary-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 5px;
      min-width: 120px;
      flex: 1;
    }
    .summary-value {
      font-size: 14px;
      color: #2c5282;
      margin-top: 5px;
    }

    /* Edit Lock Warning */
    .edit-lock-warning {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #c53030;
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      z-index: 9999;
      display: none;
    }

    /* Contact Selection Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    .modal-header {
      padding: 15px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-body {
      padding: 15px;
      max-height: 60vh;
      overflow-y: auto;
    }
    .modal-footer {
      padding: 15px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .contact-item {
      padding: 10px;
      border-bottom: 1px solid #e2e8f0;
      cursor: pointer;
      transition: background 0.2s;
    }
    .contact-item:hover {
      background: #f7fafc;
    }
    .contact-item.selected {
      background: #ebf8ff;
      border-left: 3px solid #3182ce;
    }
    .contact-search {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
    }

    /* Signature Section */
    .signature-section {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
    }
    .signature-upload {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .signature-preview {
      width: 200px;
      height: 80px;
      border: 1px dashed #cbd5e0;
      border-radius: 4px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8fafc;
    }
    .signature-preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .signature-actions {
      display: flex;
      gap: 10px;
    }

    /* Payslip Styles - A4 Landscape, Two A5 Portrait Pages */
    .payslip-container {
      display: none;
    }

    @media print {
      body { visibility: hidden; }
      .payslip-container { display: block !important; visibility: visible; }
      @page {
        size: A4 landscape;
        margin: 0.5cm;
      }
      .payslip-page {
        width: 100%;
        height: 100%;
        display: block;
        margin: 0;
        padding: 0;
      }
      .payslip-dual {
        display: flex;
        width: 100%;
        height: 100%;
      }
      .payslip-copy {
        width: 50%;
        height: 100%;
        padding: 10px;
        box-sizing: border-box;
        page-break-inside: avoid;
      }
      .payslip-table {
        font-size: 9px;
      }
      .payslip-table th, .payslip-table td {
        padding: 3px;
        line-height: 1.2;
      }
      .signature-section {
        margin-top: 10px;
        font-size: 9px;
      }
      .signature-line {
        height: 1px;
        background: #000;
        margin: 8px 0 4px;
      }
      .confidential-footer {
        font-size: 8px;
        margin-top: 6px;
      }
      .print-button { display: none; }
      .signature-preview img {
        max-width: 100%;
        max-height: 30px;
      }
    }

    .payslip-dual {
      display: flex;
      width: 100%;
      gap: 0;
    }
    .payslip-copy {
      width: 50%;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      box-sizing: border-box;
      position: relative;
      page-break-inside: avoid;
    }
    .copy-label {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #f0f0f0;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: bold;
    }
    .payslip-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
      font-size: 10px;
    }
    .payslip-table th, .payslip-table td {
      border: 1px solid #aaa;
      padding: 5px;
      font-size: 10px;
    }
    .payslip-table th {
      background: #f0f0f0;
      font-weight: bold;
    }
    .signature-section {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ccc;
      font-size: 12px;
    }
    .signature-box {
      width: 48%;
      text-align: center;
    }
    .signature-line {
      height: 1px;
      background: #000;
      margin: 10px 0 5px;
    }
    .signature-image {
      max-width: 150px;
      max-height: 40px;
      margin: 0 auto;
      display: block;
    }
    .confidential-footer {
      margin-top: 10px;
      text-align: center;
      font-size: 8px;
      color: #666;
      font-style: italic;
      border-top: 1px solid #eee;
      padding-top: 5px;
    }
    .print-button {
      text-align: center;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="edit-lock-warning" id="editLockWarning">
    ⚠️ Another session is editing this payroll. Avoid concurrent edits.
  </div>

  <div class="container">
    <header>
      <h1>Apt Engineering Works Ltd</h1>
      <p>Advanced Payroll Management System</p>
    </header>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button class="tab-btn active" onclick="switchTab('current')">
        <i class="fas fa-file-invoice-dollar"></i> Current Payroll
      </button>
      <button class="tab-btn" onclick="switchTab('history')">
        <i class="fas fa-history"></i> Payment History
      </button>
      <button class="tab-btn" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i> Settings
      </button>
    </div>

    <!-- Current Payroll Tab -->
    <div id="currentTab" class="tab-content active">
      <div class="panel">
        <div class="panel-header" onclick="togglePanel(this)">
          <h2><i class="fas fa-cog"></i> Deduction Settings</h2>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="panel-content">
          <div class="payment-date-selector">
            <label for="paymentDate"><i class="far fa-calendar-alt"></i> Payment Date:</label>
            <input type="date" id="paymentDate" onchange="updatePaymentDate()">
          </div>
          <div class="toggle-container">
            <input type="checkbox" id="toggleDeductions" checked>
            <label for="toggleDeductions">Show Deduction Rates</label>
          </div>
          <div class="toggle-container">
            <input type="checkbox" id="toggleCalculated" checked>
            <label for="toggleCalculated">Show Calculated Fields</label>
          </div>
          <div class="deductions-grid" id="deductionsPanel">
            <div class="form-group">
              <label><i class="fas fa-percent"></i> PAYE - Permanent (%)</label>
              <input type="number" id="payePermanent" value="12" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-percent"></i> PAYE - Contract (%)</label>
              <input type="number" id="payeContract" value="5" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-money-bill-wave"></i> Staff Pension - Permanent (%)</label>
              <input type="number" id="staffPensionPermanent" value="7.5" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-building"></i> Company Pension (%)</label>
              <input type="number" id="companyPension" value="15" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-heartbeat"></i> Medicals Insurance (%)</label>
              <input type="number" id="medicals" value="1" step="0.1">
            </div>
            <div class="form-group">
              <label><i class="fas fa-hard-hat"></i> Workmen Insurance (%)</label>
              <input type="number" id="workmen" value="1" step="0.1">
            </div>
          </div>
          <div class="action-buttons">
            <button class="btn btn-warning" onclick="addEmployee()">
              <i class="fas fa-user-plus"></i> Add Employee
            </button>
            <button class="btn btn-info" onclick="loadContactsFromWorkManager()">
              <i class="fas fa-sync"></i> Sync Contacts
            </button>
            <button class="btn btn-info" onclick="syncAllEmployeesToWorkManager()">
              <i class="fas fa-sync-alt"></i> Sync to Work Manager
            </button>
            <button class="btn btn-success" onclick="exportCSV()">
              <i class="fas fa-file-export"></i> Export CSV
            </button>
            <button class="btn btn-primary" onclick="savePayrollRun()">
              <i class="fas fa-save"></i> Save Payroll Run
            </button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header" onclick="togglePanel(this)">
          <h2><i class="fas fa-users"></i> Employee List <span id="employeeCount">0</span></h2>
          <i class="fas fa-chevron-down toggle-icon"></i>
        </div>
        <div class="panel-content">
          <div class="table-container">
            <table id="payrollTable">
              <thead>
                <tr>
                  <th>Name</th><th>ID No</th><th>Status</th><th>Days</th><th>Basic</th>
                  <th>Transport</th><th>Housing</th><th>IOU</th>
                  <th class="calculated-cell">Gross Pay</th><th class="calculated-cell">Net Pay</th>
                  <th class="calculated-cell">Personnel Cost</th><th class="calculated-cell">External</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="summary" id="summary">
        <div class="summary-item">
          <div><i class="fas fa-users"></i> Total Employees</div>
          <div class="summary-value" id="totalEmployees">0</div>
        </div>
        <div class="summary-item">
          <div><i class="fas fa-money-bill-wave"></i> Total Gross Pay</div>
          <div class="summary-value" id="totalGross">₦0.00</div>
        </div>
        <div class="summary-item">
          <div><i class="fas fa-wallet"></i> Total Net Pay</div>
          <div class="summary-value" id="totalNet">₦0.00</div>
        </div>
        <div class="summary-item">
          <div><i class="fas fa-building"></i> Total Personnel Cost</div>
          <div class="summary-value" id="totalPersonnel">₦0.00</div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div id="historyTab" class="tab-content">
      <div class="panel">
        <div class="panel-header">
          <h2><i class="fas fa-history"></i> Payroll History</h2>
        </div>
        <div class="panel-content">
          <div class="form-group" style="width: 200px;">
            <select id="historyFilter" class="input-field" onchange="filterHistory()">
              <option value="all">All Months</option>
              <option value="last3">Last 3 Months</option>
              <option value="last6">Last 6 Months</option>
              <option value="year">This Year</option>
            </select>
          </div>
          <div class="history-grid" id="historyContainer"></div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="tab-content">
      <div class="panel">
        <div class="panel-header">
          <h2><i class="fas fa-user-tie"></i> Manager Settings</h2>
        </div>
        <div class="panel-content">
          <div class="form-group">
            <label for="managerName"><i class="fas fa-signature"></i> Manager Name for Payslips</label>
            <input type="text" id="managerName" value="John Manager" onchange="updateManagerName(this.value)">
          </div>
          
          <!-- Signature Upload Section -->
          <div class="form-group" style="margin-top: 20px;">
            <label><i class="fas fa-file-signature"></i> Manager Signature</label>
            <div class="signature-upload">
              <div class="signature-preview" id="signaturePreview">
                <span id="signaturePlaceholder" style="color: #a0aec0;">No signature uploaded</span>
              </div>
              <div class="signature-actions">
                <input type="file" id="signatureUpload" accept="image/*" style="display: none;"
                       onchange="handleSignatureUpload(event)">
                <button class="btn btn-info" onclick="document.getElementById('signatureUpload').click()">
                  <i class="fas fa-upload"></i> Upload
                </button>
                <button class="btn btn-danger" onclick="removeSignature()">
                  <i class="fas fa-trash"></i> Remove
                </button>
              </div>
            </div>
            <p style="font-size: 11px; color: #718096; margin-top: 8px;">
              Upload a clear image of your signature (PNG, JPG). Recommended size: 300x100 pixels.
            </p>
          </div>
          
          <div class="action-buttons">
            <button class="btn btn-info" onclick="backupData()">
              <i class="fas fa-file-export"></i> Backup Data
            </button>
            <button class="btn btn-warning" onclick="restoreData()">
              <i class="fas fa-file-import"></i> Restore Data
            </button>
            <button class="btn btn-danger" onclick="resetData()">
              <i class="fas fa-trash-alt"></i> Reset All Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Contact Selection Modal -->
  <div class="modal" id="contactModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Select Contact</h3>
        <button onclick="closeContactModal()" style="background: none; border: none; font-size: 18px;">&times;</button>
      </div>
      <div class="modal-body">
        <input type="text" id="contactSearch" class="contact-search" placeholder="Search contacts..." 
               oninput="filterContacts()">
        <div id="contactsList"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="closeContactModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmContactSelection()">Select</button>
      </div>
    </div>
  </div>

  <!-- Payslip Container -->
  <div class="payslip-container" id="payslipContainer"></div>

  <!-- Hidden File Input for Restore -->
  <input type="file" id="restoreFileInput" accept=".json" style="display: none;">

  <script>
    // === Edit Lock System ===
    const LOCK_KEY = "aptPayrollEditLock";
    const LOCK_TIMEOUT = 5 * 60 * 1000; // 5 minutes

    function acquireEditLock() {
      const now = Date.now();
      const existing = localStorage.getItem(LOCK_KEY);
      if (existing && (now - parseInt(existing) < LOCK_TIMEOUT)) {
        document.getElementById("editLockWarning").style.display = "block";
      } else {
        localStorage.setItem(LOCK_KEY, now);
      }
      setInterval(() => localStorage.setItem(LOCK_KEY, Date.now()), 120000);
    }

    // === Data Management ===
    let employees = [];
    let payrollHistory = [];
    let managerName = "John Manager";
    let signatureImage = null;
    let currentPaymentDate = new Date().toISOString().split('T')[0];
    const localStorageKey = "aptEngineeringPayrollData";
    const signatureStorageKey = "aptPayrollSignature";

    // Default sample data
    function resetToDefault() {
      employees = [
        { name: "Abe Abiola", idNo: "AEWP-001", status: "Permanent", daysWorked: 22, basic: 35000, transport: 15000, housing: 15000, iou: 0 },
        { name: "Jeremiah Dennis", idNo: "AEWP-004", status: "Contract", daysWorked: 16, basic: 60000, transport: 3500, housing: 0, iou: 0 },
        { name: "Chinwe Okonkwo", idNo: "AEWP-007", status: "Permanent", daysWorked: 20, basic: 42000, transport: 12000, housing: 18000, iou: 5000 },
        { name: "Oluwaseun Adebayo", idNo: "AEWP-012", status: "Contract", daysWorked: 18, basic: 55000, transport: 8000, housing: 0, iou: 2500 }
      ];
      payrollHistory = [];
      managerName = "John Manager";
      signatureImage = null;
      currentPaymentDate = new Date().toISOString().split('T')[0];
    }

    function loadData() {
      const savedData = localStorage.getItem(localStorageKey);
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          employees = data.employees || [];
          payrollHistory = data.payrollHistory || [];
          managerName = data.managerName || "John Manager";
          currentPaymentDate = data.currentPaymentDate || new Date().toISOString().split('T')[0];
          document.getElementById('managerName').value = managerName;
        } catch (e) {
          console.error("Failed to load data", e);
          resetToDefault();
        }
      } else {
        resetToDefault();
      }
      
      // Load signature
      loadSignature();
    }

    function saveData() {
      const data = { employees, payrollHistory, managerName, currentPaymentDate };
      localStorage.setItem(localStorageKey, JSON.stringify(data));
    }

    // === Notification System ===
    function showNotification(message, type = "info") {
      const notif = document.createElement("div");
      notif.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#e53e3e' : '#3182ce'};
        color: white; padding: 10px 20px; border-radius: 6px; z-index: 9999;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 14px;
      `;
      notif.textContent = message;
      document.body.appendChild(notif);
      setTimeout(() => notif.remove(), 4000);
    }

    // === UI Functions ===
    window.onload = () => {
      acquireEditLock();
      loadData();
      document.getElementById('paymentDate').value = currentPaymentDate;
      renderTable();
      renderHistory();
      // Initialize toggles
      document.getElementById('toggleDeductions').onchange = (e) => {
        document.getElementById('deductionsPanel').style.display = e.target.checked ? 'grid' : 'none';
      };
      document.getElementById('toggleCalculated').onchange = (e) => {
        document.getElementById('payrollTable').classList.toggle('hide-calculated', !e.target.checked);
      };
      // Load contacts from work manager on startup
      loadContactsFromWorkManager();
    };

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tabId + 'Tab').classList.add('active');
      event.currentTarget.classList.add('active');
      if (tabId === 'history') renderHistory();
    }

    function updatePaymentDate() {
      currentPaymentDate = document.getElementById('paymentDate').value;
      saveData();
    }

    function updateManagerName(name) {
      managerName = name;
      saveData();
    }

    // === Contact Selection System ===
    let availableContacts = [];
    let currentEmployeeIndex = null;
    let selectedContactIndex = null;

    function openContactModal(employeeIndex) {
      currentEmployeeIndex = employeeIndex;
      selectedContactIndex = null;
      
      const modal = document.getElementById('contactModal');
      const contactsList = document.getElementById('contactsList');
      const contactSearch = document.getElementById('contactSearch');
      
      // Reset search
      contactSearch.value = '';
      
      // Populate contacts list
      contactsList.innerHTML = '';
      if (availableContacts.length === 0) {
        contactsList.innerHTML = '<div class="contact-item">No contacts available. Sync from Work Manager first.</div>';
        return;
      }
      
      availableContacts.forEach((contact, index) => {
        const contactItem = document.createElement('div');
        contactItem.className = 'contact-item';
        contactItem.innerHTML = `
          <div><strong>${contact.name}</strong></div>
          <div style="font-size: 12px; color: #718096;">${contact.designation || 'No designation'}</div>
        `;
        contactItem.onclick = () => {
          document.querySelectorAll('.contact-item').forEach(item => item.classList.remove('selected'));
          contactItem.classList.add('selected');
          selectedContactIndex = index;
        };
        contactsList.appendChild(contactItem);
      });
      
      modal.style.display = 'flex';
    }

    function closeContactModal() {
      document.getElementById('contactModal').style.display = 'none';
      currentEmployeeIndex = null;
      selectedContactIndex = null;
    }

    function filterContacts() {
      const searchTerm = document.getElementById('contactSearch').value.toLowerCase();
      const contactsList = document.getElementById('contactsList');
      
      document.querySelectorAll('.contact-item').forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? 'block' : 'none';
      });
    }

    function confirmContactSelection() {
      if (selectedContactIndex === null) {
        showNotification("Please select a contact first", "error");
        return;
      }
      
      const contact = availableContacts[selectedContactIndex];
      const employee = employees[currentEmployeeIndex];
      
      // Update employee with contact info
      employee.name = contact.name;
      
      // Update status based on designation
      if (contact.designation && contact.designation.toLowerCase().includes('contract')) {
        employee.status = "Contract";
      } else {
        employee.status = "Permanent";
      }
      
      renderTable();
      closeContactModal();
      showNotification(`Selected contact: ${contact.name}`, "success");
    }

    // === Sync Contacts from apt-work-manager.html ===
    async function loadContactsFromWorkManager() {
      const WORK_MANAGER_URL = 'https://raw.githubusercontent.com/Apt-EWorks/aework_manager.github.io/main/apt-work-manager.html';
      try {
        const response = await fetch(WORK_MANAGER_URL);
        if (!response.ok) throw new Error('Failed to fetch work manager');
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const script = Array.from(doc.scripts).find(s => s.textContent.includes('getData'));
        if (!script) throw new Error('Work manager script not found');

        // Extract contacts data
        const contactsMatch = script.textContent.match(/getData\s*\(\s*['"]contacts['"]\s*\)\s*=\s*(\[[^\]]+\])/);
        if (!contactsMatch) throw new Error('Contacts data not found in work manager');

        availableContacts = JSON.parse(contactsMatch[1]);
        
        // Update any existing employees with contact info
        employees.forEach(emp => {
          const contact = availableContacts.find(c => c.name === emp.name);
          if (contact) {
            // Update status based on designation
            if (contact.designation && contact.designation.toLowerCase().includes('contract')) {
              emp.status = "Contract";
            }
          }
        });
        
        renderTable();
        showNotification("Contacts loaded from Work Manager!", "success");
      } catch (error) {
        console.warn("Could not load contacts from work manager:", error.message);
        showNotification("Using local data. Could not sync contacts.", "info");
        // Keep existing data or default
        if (employees.length === 0) {
          resetToDefault();
          renderTable();
        }
      }
    }

    // === Sync Payroll Employees to Work Manager Contacts ===
    function syncEmployeeToWorkManager(employee) {
      try {
        // Get current contacts from localStorage
        let contacts = [];
        const contactsStr = localStorage.getItem('aptWorkManager_contacts');
        if (contactsStr) {
          contacts = JSON.parse(contactsStr);
        }
        
        // Check if contact already exists
        const exists = contacts.some(c => c.name === employee.name);
        if (exists) return false;
        
        // Add new contact
        contacts.push({
          name: employee.name,
          designation: employee.status + " Staff",
          phone1: "",
          email1: ""
        });
        
        // Save back to localStorage
        localStorage.setItem('aptWorkManager_contacts', JSON.stringify(contacts));
        
        // Dispatch event to notify work manager (if loaded)
        window.dispatchEvent(new Event('workManagerDataUpdated'));
        
        return true;
      } catch (error) {
        console.error("Error syncing to work manager:", error);
        return false;
      }
    }

    function syncAllEmployeesToWorkManager() {
      let syncedCount = 0;
      employees.forEach(employee => {
        if (syncEmployeeToWorkManager(employee)) {
          syncedCount++;
        }
      });
      
      if (syncedCount > 0) {
        showNotification(`Synced ${syncedCount} new employees to Work Manager`, "success");
      } else {
        showNotification("All employees are already in Work Manager contacts", "info");
      }
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      employees.forEach((emp, index) => {
        const gross = calculateGross(emp);
        const deductions = calculateDeductions(emp, gross);
        const net = calculateNet(emp, gross, deductions);
        const personnelCost = deductions.staffPension + deductions.companyPension;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>
            <div class="contact-selector">
              <input class="input-field" type="text" value="${emp.name}" onchange="updateField(${index}, 'name', this.value)">
              <button onclick="openContactModal(${index})" title="Select from contacts">
                <i class="fas fa-address-book"></i>
              </button>
            </div>
          </td>
          <td><input class="input-field" type="text" value="${emp.idNo}" onchange="updateField(${index}, 'idNo', this.value)"></td>
          <td><select class="input-field" onchange="updateField(${index}, 'status', this.value)">
            <option ${emp.status==='Permanent'?'selected':''}>Permanent</option>
            <option ${emp.status==='Contract'?'selected':''}>Contract</option>
          </select></td>
          <td><input class="input-field" type="number" value="${emp.daysWorked}" onchange="updateField(${index}, 'daysWorked', parseFloat(this.value))"></td>
          <td><input class="input-field" type="number" value="${emp.basic}" onchange="updateField(${index}, 'basic', parseFloat(this.value))"></td>
          <td><input class="input-field" type="number" value="${emp.transport}" onchange="updateField(${index}, 'transport', parseFloat(this.value))"></td>
          <td><input class="input-field" type="number" value="${emp.housing}" onchange="updateField(${index}, 'housing', parseFloat(this.value))"></td>
          <td><input class="input-field" type="number" value="${emp.iou}" onchange="updateField(${index}, 'iou', parseFloat(this.value))"></td>
          <td class="calculated-cell"><div class="calculated-value">${formatCurrency(gross)}</div></td>
          <td class="calculated-cell"><div class="calculated-value">${formatCurrency(net)}</div></td>
          <td class="calculated-cell"><div class="calculated-value">${formatCurrency(personnelCost)}</div></td>
          <td class="calculated-cell"><div class="calculated-value">${formatCurrency(net)}</div></td>
          <td>
            <button class="btn btn-primary" onclick="generatePayslip(${index})"><i class="fas fa-file-alt"></i> Slip</button>
            <button class="btn btn-danger" onclick="deleteEmployee(${index})"><i class="fas fa-trash-alt"></i></button>
          </td>
        `;
        tbody.appendChild(row);
      });
      updateSummary();
      saveData();
    }

    function updateField(index, field, value) {
      employees[index][field] = value;
      renderTable();
      
      // If updating name, sync to work manager
      if (field === 'name') {
        const employee = employees[index];
        if (syncEmployeeToWorkManager(employee)) {
          showNotification(`Updated contact "${employee.name}" in Work Manager`, "success");
        }
      }
    }

    function deleteEmployee(index) {
      if (confirm("Delete this employee?")) {
        employees.splice(index, 1);
        renderTable();
      }
    }

    function addEmployee() {
      const newId = `AEWP-${String(employees.length + 1).padStart(3, '0')}`;
      const newEmployee = {
        name: "New Employee",
        idNo: newId,
        status: "Permanent",
        daysWorked: 22,
        basic: 30000,
        transport: 10000,
        housing: 12000,
        iou: 0
      };
      
      employees.push(newEmployee);
      renderTable();
      
      // Immediately sync the new employee to work manager
      if (syncEmployeeToWorkManager(newEmployee)) {
        showNotification(`Employee "${newEmployee.name}" added to Work Manager contacts`, "success");
      }
    }

    // === Signature Management ===
    function loadSignature() {
      signatureImage = localStorage.getItem(signatureStorageKey);
      updateSignaturePreview();
    }

    function updateSignaturePreview() {
      const preview = document.getElementById('signaturePreview');
      const placeholder = document.getElementById('signaturePlaceholder');
      
      if (signatureImage) {
        preview.innerHTML = `<img src="${signatureImage}" alt="Manager Signature">`;
        placeholder.style.display = 'none';
      } else {
        preview.innerHTML = `<span id="signaturePlaceholder" style="color: #a0aec0;">No signature uploaded</span>`;
      }
    }

    function handleSignatureUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Check file type
      if (!file.type.match('image.*')) {
        showNotification("Please select an image file (PNG, JPG)", "error");
        return;
      }
      
      // Check file size (max 1MB)
      if (file.size > 1024 * 1024) {
        showNotification("File too large. Maximum size is 1MB", "error");
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        signatureImage = e.target.result;
        localStorage.setItem(signatureStorageKey, signatureImage);
        updateSignaturePreview();
        showNotification("Signature uploaded successfully", "success");
      };
      reader.readAsDataURL(file);
    }

    function removeSignature() {
      if (confirm("Are you sure you want to remove the signature?")) {
        signatureImage = null;
        localStorage.removeItem(signatureStorageKey);
        updateSignaturePreview();
        showNotification("Signature removed", "success");
      }
    }

    // === Calculations ===
    function calculateGross(emp) {
      return emp.status === "Permanent"
        ? (emp.basic + emp.transport + emp.housing) * emp.daysWorked
        : (emp.basic + emp.transport) * emp.daysWorked;
    }

    function calculateDeductions(emp, gross) {
      const payeRate = emp.status === "Permanent"
        ? parseFloat(document.getElementById("payePermanent").value) / 100
        : parseFloat(document.getElementById("payeContract").value) / 100;
      const staffPensionRate = emp.status === "Permanent"
        ? parseFloat(document.getElementById("staffPensionPermanent").value) / 100
        : 0;
      const companyPensionRate = parseFloat(document.getElementById("companyPension").value) / 100;
      const medicalsRate = parseFloat(document.getElementById("medicals").value) / 100;
      const workmenRate = parseFloat(document.getElementById("workmen").value) / 100;

      return {
        paye: gross * payeRate,
        staffPension: gross * staffPensionRate,
        companyPension: gross * companyPensionRate,
        medicals: gross * medicalsRate,
        workmen: gross * workmenRate
      };
    }

    function calculateNet(emp, gross, deductions) {
      const totalDeductions = deductions.paye + deductions.staffPension + deductions.medicals + deductions.workmen + emp.iou;
      return gross - totalDeductions;
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(value || 0);
    }

    function formatDate(dateStr) {
      return new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function updateSummary() {
      const totalGross = employees.reduce((sum, e) => sum + calculateGross(e), 0);
      const totalNet = employees.reduce((sum, e) => {
        const gross = calculateGross(e);
        const deductions = calculateDeductions(e, gross);
        return sum + calculateNet(e, gross, deductions);
      }, 0);
      const totalPersonnel = employees.reduce((sum, e) => {
        const gross = calculateGross(e);
        const deductions = calculateDeductions(e, gross);
        return sum + (deductions.staffPension + deductions.companyPension);
      }, 0);

      document.getElementById("totalEmployees").textContent = employees.length;
      document.getElementById("totalGross").textContent = formatCurrency(totalGross);
      document.getElementById("totalNet").textContent = formatCurrency(totalNet);
      document.getElementById("totalPersonnel").textContent = formatCurrency(totalPersonnel);
      document.getElementById("employeeCount").textContent = employees.length;
    }

    // === Payslip Generation ===
    function generatePayslip(index) {
      const emp = employees[index];
      const gross = calculateGross(emp);
      const deductions = calculateDeductions(emp, gross);
      const totalDeductions = deductions.paye + deductions.staffPension + deductions.medicals + deductions.workmen + emp.iou;
      const net = calculateNet(emp, gross, deductions);
      const month = new Date().toLocaleString('default', { month: 'long' });

      const container = document.getElementById("payslipContainer");
      container.innerHTML = `
        <div class="payslip-page">
          <div class="payslip-dual">
            <!-- Personnel Copy -->
            <div class="payslip-copy">
              <div class="copy-label">PERSONNEL COPY</div>
              <h3 style="margin:10px 0;">Apt Engineering Works Ltd</h3>
              <div style="font-size:11px; margin-bottom:10px;">
                <strong>Month:</strong> ${month} |
                <strong>Payment Date:</strong> ${formatDate(currentPaymentDate)}
              </div>
              <table class="payslip-table">
                <tr><th>Employee Name:</th><td>${emp.name}</td></tr>
                <tr><th>ID Number:</th><td>${emp.idNo}</td></tr>
                <tr><th>Status:</th><td>${emp.status}</td></tr>
                <tr><th>Days Worked:</th><td>${emp.daysWorked}</td></tr>
              </table>
              <h4>Earnings</h4>
              <table class="payslip-table">
                <tr><td>Basic Pay</td><td>${formatCurrency(emp.basic)}</td></tr>
                <tr><td>Transport</td><td>${formatCurrency(emp.transport)}</td></tr>
                <tr><td>Housing</td><td>${formatCurrency(emp.housing)}</td></tr>
                <tr><th>Gross Pay</th><td>${formatCurrency(gross)}</td></tr>
              </table>
              <h4>Deductions</h4>
              <table class="payslip-table">
                <tr><td>PAYE</td><td>${formatCurrency(deductions.paye)}</td></tr>
                <tr><td>Staff Pension</td><td>${formatCurrency(deductions.staffPension)}</td></tr>
                <tr><td>Medicals</td><td>${formatCurrency(deductions.medicals)}</td></tr>
                <tr><td>Workmen</td><td>${formatCurrency(deductions.workmen)}</td></tr>
                <tr><td>IOU</td><td>${formatCurrency(emp.iou)}</td></tr>
                <tr><th>Total Deductions</th><td>${formatCurrency(totalDeductions)}</td></tr>
              </table>
              <h4>Net Pay</h4>
              <h2 style="color:#2c5282; text-align:center;">${formatCurrency(net)}</h2>
              <div class="signature-section">
                <div class="signature-box">
                  <div>Staff Signature</div>
                  <div class="signature-line"></div>
                </div>
              </div>
            </div>

            <!-- Company Copy -->
            <div class="payslip-copy">
              <div class="copy-label">COMPANY COPY</div>
              <h3 style="margin:10px 0;">Apt Engineering Works Ltd</h3>
              <div style="font-size:11px; margin-bottom:10px;">
                <strong>Month:</strong> ${month} |
                <strong>Payment Date:</strong> ${formatDate(currentPaymentDate)}
              </div>
              <table class="payslip-table">
                <tr><th>Employee Name:</th><td>${emp.name}</td></tr>
                <tr><th>ID Number:</th><td>${emp.idNo}</td></tr>
                <tr><th>Status:</th><td>${emp.status}</td></tr>
                <tr><th>Days Worked:</th><td>${emp.daysWorked}</td></tr>
              </table>
              <h4>Earnings</h4>
              <table class="payslip-table">
                <tr><td>Basic Pay</td><td>${formatCurrency(emp.basic)}</td></tr>
                <tr><td>Transport</td><td>${formatCurrency(emp.transport)}</td></tr>
                <tr><td>Housing</td><td>${formatCurrency(emp.housing)}</td></tr>
                <tr><th>Gross Pay</th><td>${formatCurrency(gross)}</td></tr>
              </table>
              <h4>Deductions</h4>
              <table class="payslip-table">
                <tr><td>PAYE</td><td>${formatCurrency(deductions.paye)}</td></tr>
                <tr><td>Staff Pension</td><td>${formatCurrency(deductions.staffPension)}</td></tr>
                <tr><td>Medicals</td><td>${formatCurrency(deductions.medicals)}</td></tr>
                <tr><td>Workmen</td><td>${formatCurrency(deductions.workmen)}</td></tr>
                <tr><td>IOU</td><td>${formatCurrency(emp.iou)}</td></tr>
                <tr><th>Total Deductions</th><td>${formatCurrency(totalDeductions)}</td></tr>
              </table>
              <h4>Net Pay</h4>
              <h2 style="color:#2c5282; text-align:center;">${formatCurrency(net)}</h2>
              <div class="signature-section">
                <div class="signature-box">
                  <div>Manager: ${managerName}</div>
                  ${signatureImage ? `<img src="${signatureImage}" class="signature-image">` : '<div class="signature-line"></div>'}
                </div>
              </div>
            </div>
          </div>
          <div class="confidential-footer">This document contains confidential information.</div>
          <div class="print-button">
            <button class="btn btn-primary" onclick="printPayslip()"><i class="fas fa-print"></i> Print Payslip</button>
          </div>
        </div>
      `;
      container.style.display = 'block';
    }

    function printPayslip() {
      window.print();
    }

    // === History & Backup ===
    function savePayrollRun() {
      if (!currentPaymentDate) return alert("Select payment date.");
      const run = {
        id: Date.now(),
        date: currentPaymentDate,
        employees: JSON.parse(JSON.stringify(employees)),
        totals: {
          employees: employees.length,
          gross: employees.reduce((s, e) => s + calculateGross(e), 0),
          net: employees.reduce((s, e) => {
            const g = calculateGross(e); const d = calculateDeductions(e, g);
            return s + calculateNet(e, g, d);
          }, 0),
          personnelCost: employees.reduce((s, e) => {
            const g = calculateGross(e); const d = calculateDeductions(e, g);
            return s + (d.staffPension + d.companyPension);
          }, 0)
        },
        deductions: {
          payePermanent: parseFloat(document.getElementById("payePermanent").value),
          payeContract: parseFloat(document.getElementById("payeContract").value),
          staffPensionPermanent: parseFloat(document.getElementById("staffPensionPermanent").value),
          companyPension: parseFloat(document.getElementById("companyPension").value),
          medicals: parseFloat(document.getElementById("medicals").value),
          workmen: parseFloat(document.getElementById("workmen").value)
        }
      };
      payrollHistory.unshift(run);
      saveData();
      renderHistory();
      alert(`Payroll saved for ${formatDate(currentPaymentDate)}!`);
    }

    function renderHistory() {
      const container = document.getElementById("historyContainer");
      container.innerHTML = "";
      const filter = document.getElementById("historyFilter").value;
      let filtered = [...payrollHistory];
      const now = new Date();
      if (filter === "last3") {
        const d = new Date(); d.setMonth(d.getMonth() - 3);
        filtered = filtered.filter(r => new Date(r.date) >= d);
      } else if (filter === "last6") {
        const d = new Date(); d.setMonth(d.getMonth() - 6);
        filtered = filtered.filter(r => new Date(r.date) >= d);
      } else if (filter === "year") {
        filtered = filtered.filter(r => new Date(r.date).getFullYear() === now.getFullYear());
      }

      if (filtered.length === 0) {
        container.innerHTML = `<div style="text-align:center;padding:20px;color:#718096;">No history found.</div>`;
        return;
      }

      filtered.forEach(r => {
        const card = document.createElement("div");
        card.className = "history-card";
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;"><b>${formatDate(r.date)}</b><span>${r.employees.length} emp</span></div>
          <div style="margin:10px 0;">
            <div><b>Total Gross:</b> ${formatCurrency(r.totals.gross)}</div>
            <div><b>Net Pay:</b> ${formatCurrency(r.totals.net)}</div>
          </div>
          <div style="display:flex;gap:5px;">
            <button class="btn" style="background:#3182ce;color:white;" onclick="viewPayrollRun(${r.id})"><i class="fas fa-eye"></i> View</button>
            <button class="btn" style="background:#dd6b20;color:white;" onclick="reusePayrollRun(${r.id})"><i class="fas fa-redo"></i> Reuse</button>
            <button class="btn" style="background:#e53e3e;color:white;" onclick="deletePayrollRun(${r.id})"><i class="fas fa-trash"></i> Delete</button>
          </div>`;
        container.appendChild(card);
      });
    }

    function viewPayrollRun(id) {
      const run = payrollHistory.find(r => r.id === id);
      if (!run) return;
      const temp = [...employees];
      employees = JSON.parse(JSON.stringify(run.employees));
      currentPaymentDate = run.date;
      document.getElementById('paymentDate').value = currentPaymentDate;
      Object.keys(run.deductions).forEach(k => document.getElementById(k).value = run.deductions[k]);
      renderTable();
      switchTab('current');
      setTimeout(() => employees = temp, 100);
      alert("Viewing historical payroll. Changes not saved unless saved explicitly.");
    }

    function reusePayrollRun(id) {
      if (!confirm("Replace current data with this run?")) return;
      const run = payrollHistory.find(r => r.id === id);
      if (!run) return;
      employees = JSON.parse(JSON.stringify(run.employees));
      currentPaymentDate = new Date().toISOString().split('T')[0];
      document.getElementById('paymentDate').value = currentPaymentDate;
      Object.keys(run.deductions).forEach(k => document.getElementById(k).value = run.deductions[k]);
      renderTable();
      switchTab('current');
    }

    function deletePayrollRun(id) {
      if (confirm("Delete this payroll run?")) {
        payrollHistory = payrollHistory.filter(r => r.id !== id);
        saveData();
        renderHistory();
      }
    }

    function exportCSV() {
      let csv = "Name,ID,Status,Days,Basic,Transport,Housing,IOU,Gross,Net,Personnel,External\n";
      employees.forEach(emp => {
        const g = calculateGross(emp);
        const d = calculateDeductions(emp, g);
        const n = calculateNet(emp, g, d);
        const p = d.staffPension + d.companyPension;
        csv += `"${emp.name}","${emp.idNo}","${emp.status}",${emp.daysWorked},${emp.basic},${emp.transport},${emp.housing},${emp.iou},${g},${n},${p},${n}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `payroll_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function backupData() {
      const data = { employees, payrollHistory, managerName, currentPaymentDate, signatureImage };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    }

    function restoreData() {
      document.getElementById('restoreFileInput').click();
    }

    document.getElementById('restoreFileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (confirm(`Restore ${data.employees.length} employees and ${data.payrollHistory.length} runs?`)) {
            employees = data.employees || [];
            payrollHistory = data.payrollHistory || [];
            managerName = data.managerName || "John Manager";
            currentPaymentDate = data.currentPaymentDate || new Date().toISOString().split('T')[0];
            signatureImage = data.signatureImage || null;
            
            // Save signature to localStorage
            if (signatureImage) {
              localStorage.setItem(signatureStorageKey, signatureImage);
            }
            
            saveData();
            renderTable();
            renderHistory();
            document.getElementById('paymentDate').value = currentPaymentDate;
            document.getElementById('managerName').value = managerName;
            updateSignaturePreview();
            alert("Data restored.");
          }
        } catch (err) {
          alert("Error: " + err.message);
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    function resetData() {
      if (confirm("Reset all data?")) {
        localStorage.removeItem(localStorageKey);
        localStorage.removeItem(signatureStorageKey);
        resetToDefault();
        renderTable();
        renderHistory();
        document.getElementById('paymentDate').value = currentPaymentDate;
        document.getElementById('managerName').value = managerName;
        updateSignaturePreview();
        alert("Data reset.");
      }
    }

    function togglePanel(el) {
      el.closest('.panel').classList.toggle('collapsed');
    }
  </script>
</body>
</html>